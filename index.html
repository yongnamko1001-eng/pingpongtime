<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>탁구 토너먼트 관리 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        /* 네이버 컬러 스키마 - CSS 변수 최소화 */
        :root {
            --green: #03c75a;
            --green-hover: #02b351;
            --green-light: #e8f5e8;
            --gray: #f5f5f5;
            --border: #e0e0e0;
            --text: #333;
            --text-light: #666;
        }
        
        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: var(--green);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            touch-action: manipulation;
        }
        
        .btn:hover { background: var(--green-hover); }
        
        .btn-secondary {
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover { background: var(--gray); }
        
        .input {
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 12px;
            font-size: 16px; /* iOS 줌 방지 */
            transition: border-color 0.2s;
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px; /* 터치 타겟 */
        }
        
        .input:focus {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 0 2px rgba(3,199,90,0.1);
        }
        
        .nav-item {
            color: var(--text-light);
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .nav-item:hover { background: var(--green-light); color: var(--green); }
        .nav-item.active { background: var(--green); color: white; }
        
        .badge {
            background: var(--green-light);
            color: var(--green);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        /* 인라인 편집 스타일 */
        .editable {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .editable:hover {
            background: var(--green-light);
        }
        
        .editing {
            background: var(--green-light);
            border: 1px solid var(--green);
            border-radius: 4px;
        }
        
        .edit-input {
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            font-weight: 500;
            background: transparent;
            min-width: 80px;
            outline: none;
        }
        
        .edit-select {
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            background: transparent;
            min-width: 60px;
            outline: none;
        }
        
        
        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { 
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid var(--border);
                z-index: 1000;
            }
            .mobile-nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 6px 2px;
                color: var(--text-light);
                cursor: pointer;
                touch-action: manipulation;
            }
            .mobile-nav-item.active { color: var(--green); }
            .mobile-nav-item i { font-size: 18px; margin-bottom: 2px; }
            .mobile-nav-item span { font-size: 10px; }
            .content { padding-bottom: 80px; padding: 16px 16px 80px; }
            .form-mobile { flex-direction: column; gap: 12px; }
            .form-group { width: 100%; }
            
            /* 모바일에서 전체 화면 스크롤 방지 */
            body { overflow-x: hidden; }
            .content { overflow-x: hidden; }
            
            /* 모바일에서 순위표 스크롤 최적화 */
            .ranking-scroll-container {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* 모바일에서 조 탭 스크롤 최적화 */
            .group-tabs-container {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* 모바일에서 순위표 텍스트 한 줄 표시 */
            .ranking-table th,
            .ranking-table td {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 80px;
                font-size: 12px;
                padding: 8px 4px;
            }
            
            /* 순위표 헤더 특별 처리 */
            .ranking-table th {
                font-size: 11px;
                font-weight: 600;
                text-align: center;
            }
            
            /* 선수명과 부수는 원래 크기 유지하되 한 줄로 */
            .ranking-table td:first-child,
            .ranking-table td:nth-child(2),
            .ranking-table td:nth-child(3) {
                font-size: 14px;
                max-width: 100px;
            }
            
            /* 모바일에서 토너먼트 배정 최적화 */
            .group-players-list {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }
            
            .player-item-settings {
                padding: 16px !important;
                font-size: 16px !important;
                min-height: 56px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
            }
            
            .player-item-settings .player-level {
                font-size: 14px !important;
                padding: 6px 12px !important;
            }
            
            /* 토너먼트 슬롯 모바일 최적화 */
            #tournamentSlots {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 12px !important;
                margin-top: 16px !important;
            }
            
            .tournament-slot {
                min-height: 60px !important;
                padding: 12px !important;
                font-size: 16px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .slot-label {
                font-size: 18px !important;
                font-weight: bold !important;
                margin-bottom: 4px !important;
            }
            
            .slot-player {
                font-size: 12px !important;
                text-align: center !important;
                word-break: break-all !important;
            }
            
            /* 선택된 선수 정보 모바일 최적화 */
            #selectedPlayerInfo {
                font-size: 16px !important;
                padding: 16px !important;
                margin-bottom: 20px !important;
            }
            
            /* 모바일에서 터치 피드백 개선 */
            .player-item-settings:active {
                transform: scale(0.98) !important;
                background: var(--green) !important;
                color: white !important;
            }
            
            .tournament-slot.selectable:active {
                transform: scale(0.95) !important;
                background: var(--green-light) !important;
            }
            
            /* 모바일에서 스크롤 개선 */
            .content {
                -webkit-overflow-scrolling: touch !important;
                scroll-behavior: smooth !important;
            }
            
            /* 모바일 간단한 슬롯 스타일 */
            .mobile-simple-slot:active {
                transform: scale(0.95) !important;
                background: var(--green-light) !important;
                border-color: var(--green) !important;
            }
            
            .mobile-simple-slot:hover {
                transform: scale(1.02) !important;
                box-shadow: 0 4px 8px rgba(3, 199, 90, 0.2) !important;
            }
            
            /* 순위표 전체 최소 너비 조정 */
            .ranking-table {
                min-width: 500px;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-nav { display: none; }
            .form-mobile { flex-direction: row; align-items: center; gap: 16px; }
        }
        
        /* 조편성 전용 스타일 */
        .group-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .group-card:hover {
            border-color: var(--green);
            box-shadow: 0 4px 12px rgba(3,199,90,0.1);
        }
        
        .group-card.active {
            border-color: var(--green);
            background: var(--green-light);
        }
        
        .player-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin: 4px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .player-item:hover {
            background: var(--green-light);
            border-color: var(--green);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(3,199,90,0.15);
        }
        
        .group-option {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            touch-action: manipulation;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .group-option:hover {
            border-color: var(--green);
            background: var(--green-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(3,199,90,0.2);
        }
        
        .group-option.selected {
            border-color: var(--green);
            background: var(--green);
            color: white;
        }
        
        .drop-zone {
            min-height: 60px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            color: var(--text-light);
            transition: all 0.3s ease;
        }
        
        .drop-zone.drag-over {
            border-color: var(--green);
            background: var(--green-light);
            color: var(--green);
        }

        /* 탭 콘텐츠 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 리그전 전용 스타일 */
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .ranking-table th {
            background: var(--gray);
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .ranking-table td {
            font-size: 14px;
        }

        .ranking-table tbody tr:hover {
            background: var(--gray);
        }

        /* 순위 표시 */
        .rank-1 { color: #ffd700; font-weight: bold; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }

        /* 조 탭 스타일 */
        .group-tab {
            padding: 12px 20px;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            color: var(--text-light);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .group-tab.active {
            border-bottom-color: var(--green) !important;
            color: var(--green) !important;
        }

        .group-tab:hover {
            color: var(--text) !important;
        }

        /* 조 탭 컨테이너 - 좌우 스크롤 허용 */
        .group-tabs-container {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* 순위표 전용 스크롤 스타일 */
        .ranking-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .ranking-scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .ranking-scroll-container::-webkit-scrollbar-track {
            background: var(--gray);
            border-radius: 4px;
        }

        .ranking-scroll-container::-webkit-scrollbar-thumb {
            background: var(--green);
            border-radius: 4px;
        }

        .ranking-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--green-hover);
        }

        /* 경기 결과 색상 구분 */
        .match-result {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            text-align: center;
            min-width: 50px;
            cursor: pointer;
        }

        .match-result.win {
            background: #dcfce7;
            color: #166534;
        }

        .match-result.lose {
            background: #fee2e2;
            color: #dc2626;
        }

        .match-result.draw {
            background: #fef3c7;
            color: #d97706;
        }

        .match-result.pending {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* 경기 카드 */
        .match-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .match-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .match-card.completed {
            background: var(--gray);
            opacity: 0.8;
        }

        .match-card.current {
            border-color: var(--green);
            box-shadow: 0 0 0 2px rgba(3, 199, 90, 0.1);
        }

        .match-players {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-name {
            font-weight: 500;
        }

        .player-level {
            background: var(--green);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .vs {
            font-weight: bold;
            color: var(--text-light);
            margin: 0 16px;
        }

        .match-score {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .score-input {
            width: 50px;
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: center;
        }

        /* 애니메이션 최소화 */
        .fade-in { opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }

        /* 토너먼트 대진표 스타일 */
        :root {
            --box-w: 56px;
            --box-h: 28px;
            --gap-y: 36px;
        }

        .tournament-board {
            position: relative;
            height: 760px;
            background: transparent;
            border-radius: 8px;
            padding-top: 24px;
        }

        .tournament-players {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 18px;
            display: grid;
            grid-template-columns: repeat(32, 1fr);
            gap: 4px;
            padding: 0 8px;
            box-sizing: border-box;
        }

        .tournament-player {
            width: var(--box-w);
            height: var(--box-h);
            background: #dbe7ff11;
            border-radius: 6px;
            border: 1px solid #cfdff4;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #e6eefc;
            margin: 0 auto;
        }

        .tournament-qbox {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 44%;
            width: 48px;
            height: 32px;
            background: #cfdff4;
            color: #21355a;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .tournament-trophy {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 8px;
            font-size: 28px;
        }

        .tournament-bracket {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        /* 토너먼트 스크롤 컨테이너 */
        .tournament-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            border-radius: 8px;
        }

        .tournament-scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .tournament-scroll-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .tournament-scroll-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .tournament-scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* 반응형 조정 */
        @media (max-width: 420px) {
            :root {
                --box-w: 44px;
                --box-h: 26px;
                --gap-y: 30px;
            }
            .tournament-board {
                height: 820px;
                min-width: 1200px; /* 32강 대진표를 위한 최소 너비 */
            }
            .tournament-players {
                gap: 4px;
            }
            .tournament-scroll-container {
                margin: 0 -14px; /* 패딩 상쇄 */
            }
            
            /* 매우 작은 화면에서 토너먼트 배정 최적화 */
            #tournamentSlots {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }
            
            .tournament-slot {
                min-height: 50px !important;
                padding: 8px !important;
                font-size: 14px !important;
            }
            
            .slot-label {
                font-size: 16px !important;
            }
            
            .slot-player {
                font-size: 10px !important;
            }
            
            .player-item-settings {
                padding: 12px !important;
                font-size: 14px !important;
                min-height: 48px !important;
            }
        }

        @media (max-width: 768px) {
            .tournament-board {
                min-width: 1000px; /* 32강 대진표를 위한 태블릿 최소 너비 */
            }
            .mobile-scroll-hint {
                display: inline !important;
            }
        }

        /* 토너먼트 설정 탭 스타일 */
        .group-card-settings {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .group-card-settings:hover {
            border-color: var(--green);
            box-shadow: 0 2px 8px rgba(3,199,90,0.1);
        }

        .group-title-settings {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .player-item-settings {
            background: var(--gray);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-item-settings:hover {
            background: var(--green-light);
            border-color: var(--green);
            transform: translateY(-1px);
        }

        .player-item-settings.selected {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        .player-item-settings.assigned {
            background: #e3f2fd;
            border-color: #1976d2;
            color: #1976d2;
        }

        .tournament-slot {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .tournament-slot:hover {
            border-color: var(--green);
            background: var(--green-light);
        }

        .tournament-slot.assigned {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        .tournament-slot.selected {
            border-color: #ff6b6b;
            background: #ffe0e0;
        }

        /* 토너먼트 배정 모달 스타일 */
        .tournament-slot {
            transition: all 0.2s ease;
        }
        
        .tournament-slot.selectable {
            opacity: 1 !important;
            cursor: pointer !important;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(3, 199, 90, 0.2);
        }
        
        .tournament-slot.selectable:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(3, 199, 90, 0.3);
            border-color: var(--green);
        }
        
        .tournament-slot-btn {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 14px;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .tournament-slot-btn:hover {
            border-color: var(--green);
            background: var(--green-light);
            transform: translateY(-2px);
        }

        .tournament-slot-btn.assigned {
            background: #e3f2fd;
            border-color: #1976d2;
            color: #1976d2;
            cursor: not-allowed;
        }

        .tournament-slot-btn.selected {
            border-color: var(--green);
            background: var(--green);
            color: white;
            transform: scale(1.05);
        }

        .tournament-slot-btn .slot-label {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .tournament-slot-btn .slot-player {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 500;
            line-height: 1.2;
        }

        .tournament-slot-btn .slot-player.vs {
            color: #4caf50;
            font-weight: 600;
        }

        /* 삭제 버튼 스타일 */
        .btn-danger {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .btn-danger:active {
            transform: translateY(0);
        }

        /* 대진표 선택 옵션 스타일 */
        .bracket-option {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .bracket-option:hover {
            border-color: var(--green);
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .bracket-option.recommended {
            border-color: var(--green);
            background: #e8f5e8;
        }

        .bracket-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .bracket-option h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .bracket-option p {
            margin: 0;
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.4;
        }

        .recommended-badge {
            background: var(--green);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* 5명 토너먼트 전용 스타일 */
        .player-selection-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-selection-card:hover {
            border-color: var(--green);
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .player-selection-card.selected {
            border-color: var(--green);
            background: #e8f5e8;
        }

        .player-selection-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .player-info {
            display: flex;
            align-items: center;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .player-details h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .player-details p {
            margin: 0;
            font-size: 14px;
            color: var(--text-light);
        }

        .selection-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .player-selection-card.selected .selection-indicator {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }

        .selection-indicator i {
            font-size: 12px;
        }

        /* 토너먼트 배정 관리 스타일 */
        .assigned-player-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .assigned-player-item:hover {
            border-color: var(--green);
            background: var(--green-light);
            transform: translateY(-1px);
        }

        .assigned-player-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .assigned-player-slot {
            background: var(--green);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .assigned-player-name {
            font-weight: 500;
            color: var(--text);
        }

        .assigned-player-level {
            background: var(--gray);
            color: var(--text-light);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }

        .delete-assignment-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .delete-assignment-btn:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }


        .slot-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .slot-player {
            font-size: 11px;
            font-weight: 500;
            word-break: break-word;
        }

        .slot-label.assigned {
            color: white;
        }

        .slot-player.assigned {
            color: white;
        }

        /* 토너먼트 경기 관리 스타일 */
        .tournament-player {
            transition: all 0.5s ease;
            position: relative;
        }

        .tournament-player.winner {
            background: #4CAF50 !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            z-index: 10;
        }

        .tournament-player.eliminated {
            background: #f44336 !important;
            color: white !important;
            opacity: 0.6;
        }


        .tournament-player.bye {
            background: #FF9800 !important;
            color: white !important;
            border: 2px solid #F57C00;
            position: relative;
        }

        .tournament-player.bye::after {
            content: "부전승";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #F57C00;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .tournament-player.empty-slot {
            background: #f5f5f5 !important;
            color: #999 !important;
            border: 2px dashed #ccc;
            position: relative;
        }

        .tournament-player.empty-slot::after {
            content: "빈슬롯";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #999;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .tournament-player.no-match {
            background: #f5f5f5 !important;
            color: #999 !important;
            border: 2px dashed #ccc !important;
            position: relative;
        }

        .tournament-player.no-match::after {
            content: "경기 없음";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #999;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .tournament-player.bye-advance {
            background: #FF9800 !important;
            color: white !important;
            border: 2px solid #F57C00 !important;
            position: relative;
        }

        .tournament-player.bye-advance::after {
            content: "부전승";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #F57C00;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .tournament-player.eliminated {
            background: #9E9E9E !important;
            color: #666 !important;
            border: 2px solid #757575 !important;
            opacity: 0.7;
            position: relative;
        }

        .tournament-player.eliminated::after {
            content: "탈락";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #757575;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* 경기 정보 모달 스타일 */
        .match-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .match-info-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .match-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .match-info-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
        }

        .close-match-info {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
        }

        .match-details {
            margin-bottom: 20px;
        }

        .match-round {
            font-size: 16px;
            font-weight: 500;
            color: var(--green);
            margin-bottom: 12px;
        }

        .match-players {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .match-player {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .match-player:hover {
            border-color: var(--green);
            background: var(--green-light);
        }

        .match-player.selected {
            border-color: var(--green);
            background: var(--green);
            color: white;
        }

        .match-vs {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-light);
            margin: 0 16px;
        }

        .match-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-confirm {
            background: var(--green);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-confirm:hover {
            background: var(--green-hover);
        }

        .btn-confirm:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .btn-cancel {
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-cancel:hover {
            background: var(--gray);
        }

        .tournament-player {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tournament-player:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* 빈 슬롯 대진표 스타일 */
        .empty-slot-line {
            stroke: #9E9E9E !important;
            stroke-dasharray: 3,3 !important;
            stroke-width: 1.5 !important;
        }

        .empty-slot-text {
            fill: #9E9E9E !important;
            font-weight: bold !important;
            font-size: 10px !important;
        }


        .match-player {
            background: white;
            border: 2px solid var(--green);
            border-radius: 8px;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .match-player:hover {
            background: var(--green-light);
            transform: translateY(-2px);
        }

        .match-player.selected {
            background: var(--green);
            color: white;
            transform: scale(1.05);
        }

        .vs-text {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-light);
            margin: 0 20px;
        }

        .round-indicator {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--green);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
    </style>
</head>
<body style="background: var(--gray); min-height: 100vh; display: flex; flex-direction: column;">
    <!-- 헤더 -->
    <header style="background: white; border-bottom: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div style="max-width: 1280px; margin: 0 auto; padding: 0 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between; height: 60px;">
                <h1 style="font-size: 20px; font-weight: bold; color: var(--text);">
                    <i class="fas fa-user-plus" style="color: var(--green); margin-right: 8px;"></i>
                    선수등록
                </h1>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button id="integratedSaveBtn" class="btn-secondary" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-save" style="margin-right: 4px;"></i>저장
                    </button>
                    <button id="integratedLoadBtn" class="btn-secondary" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-folder-open" style="margin-right: 4px;"></i>불러오기
                    </button>
                    <button id="resetBtn" class="btn-secondary" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-refresh" style="margin-right: 4px;"></i>초기화
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 레이아웃 -->
    <div style="display: flex;">
        <!-- 사이드바 -->
        <nav class="sidebar" style="width: 240px; background: white; border-right: 1px solid var(--border); min-height: calc(100vh - 60px);">
            <div style="padding: 16px;">
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li><button class="nav-item active" style="width: 100%; text-align: left; background: none; border: none;">
                        <i class="fas fa-user-plus" style="margin-right: 8px;"></i>선수 등록
                    </button></li>
                    <li><button class="nav-item" style="width: 100%; text-align: left; background: none; border: none;">
                        <i class="fas fa-layer-group" style="margin-right: 8px;"></i>조편성
                    </button></li>
                    <li><button class="nav-item" style="width: 100%; text-align: left; background: none; border: none;">
                        <i class="fas fa-trophy" style="margin-right: 8px;"></i>리그전
                    </button></li>
                    
                    <li><button class="nav-item" onclick="switchTab('tournament')" style="width: 100%; text-align: left; background: none; border: none;">
                        <i class="fas fa-chess" style="margin-right: 8px;"></i>토너먼트
                    </button></li>
                    <li><button class="nav-item" style="width: 100%; text-align: left; background: none; border: none;">
                        <i class="fas fa-chart-line" style="margin-right: 8px;"></i>경과발표
                    </button></li>
                </ul>
            </div>
        </nav>

        <!-- 메인 콘텐츠 -->
        <main class="content" style="flex: 1; background: var(--gray); padding: 24px; display: flex; flex-direction: column;">
            <!-- 선수등록 탭 -->
            <div id="tab-players" class="tab-content active">
            <!-- 현황 카드 -->
            <div class="card" style="padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: center;">
                    <div style="display: flex; gap: 32px; align-items: center;">
                        <div style="display: flex; align-items: center;">
                            <div style="padding: 8px; border-radius: 50%; background: var(--green-light); margin-right: 12px;">
                                <i class="fas fa-users" style="font-size: 18px; color: var(--green);"></i>
                            </div>
                            <div>
                                <p style="font-size: 13px; color: var(--text-light); margin: 0;">등록된 선수</p>
                                <p id="totalPlayers" style="font-size: 24px; font-weight: bold; color: var(--text); margin: 0;">0</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="padding: 8px; border-radius: 50%; background: #e3f2fd; margin-right: 12px;">
                                <i class="fas fa-layer-group" style="font-size: 18px; color: #1976d2;"></i>
                            </div>
                            <div>
                                <p style="font-size: 13px; color: var(--text-light); margin: 0;">예상 조수</p>
                                <p id="totalGroups" style="font-size: 24px; font-weight: bold; color: var(--text); margin: 0;">0</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="padding: 8px; border-radius: 50%; background: #fff3e0; margin-right: 12px;">
                                <i class="fas fa-trophy" style="font-size: 18px; color: #f57c00;"></i>
                            </div>
                            <div>
                                <p style="font-size: 13px; color: var(--text-light); margin: 0;">예상 경기수</p>
                                <p id="totalMatches" style="font-size: 24px; font-weight: bold; color: var(--text); margin: 0;">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 등록 폼 -->
            <div class="card" style="padding: 20px; margin-bottom: 24px;">
                <div class="form-mobile" style="display: flex; align-items: center; justify-content: center;">
                    <div class="form-group">
                        <label style="font-size: 14px; font-weight: 500; color: var(--text); display: block; margin-bottom: 6px;">선수명</label>
                        <input type="text" id="nameInput" placeholder="선수 이름 입력" class="input" style="width: 100%;" 
                               autocomplete="off" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label style="font-size: 14px; font-weight: 500; color: var(--text); display: block; margin-bottom: 6px;">부수</label>
                        <select id="levelSelect" class="input" style="width: 100%;">
                            <option value="1부">1부</option>
                            <option value="2부">2부</option>
                            <option value="3부">3부</option>
                            <option value="4부">4부</option>
                            <option value="5부">5부</option>
                            <option value="6부">6부</option>
                            <option value="7부">7부</option>
                            <option value="8부">8부</option>
                            <option value="9부">9부</option>
                            <option value="10부">10부</option>
                        </select>
                    </div>
                    <button id="addBtn" class="btn" style="margin-top: 20px;">
                        <i class="fas fa-plus" style="margin-right: 6px;"></i>등록
                    </button>
                </div>
            </div>
            
            <!-- 선수 목록 -->
            <div class="card">
                <div style="padding: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0;">
                            <i class="fas fa-users" style="color: var(--green); margin-right: 8px;"></i>
                            등록된 선수 (<span id="playerCount">0</span>명)
                        </h3>
                    </div>
                    
                    <div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--gray);">
                                    <th style="padding: 12px; text-align: left; font-size: 12px; color: var(--text-light); border-bottom: 1px solid var(--border);">이름</th>
                                    <th style="padding: 12px; text-align: left; font-size: 12px; color: var(--text-light); border-bottom: 1px solid var(--border);">부수</th>
                                    <th style="padding: 12px; text-align: left; font-size: 12px; color: var(--text-light); border-bottom: 1px solid var(--border);">작업</th>
                                </tr>
                            </thead>
                            <tbody id="playersList">
                                <tr id="emptyRow">
                                    <td colspan="3" style="padding: 32px; text-align: center; color: var(--text-light);">
                                        등록된 선수가 없습니다
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- PING PONG TME 텍스트 -->
            <div style="text-align: center; padding: 20px; color: var(--text-light); font-size: 14px; font-weight: 500;">
                PING PONG TME
            </div>
            </div>

            <!-- 조편성 탭 -->
            <div id="tab-groups" class="tab-content">
                <!-- 조편성 설정 -->
                <div class="card" style="padding: 20px; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0 0 20px 0; text-align: center;">
                        <i class="fas fa-cog" style="color: var(--green); margin-right: 8px;"></i>
                        조편성
                    </h3>
                    
                    <div style="text-align: center;">
                        <h4 style="font-size: 16px; font-weight: 500; color: var(--text); margin: 0 0 16px 0;">조 개수를 설정하세요</h4>
                        <div style="display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap;">
                            <select id="groupCount" class="input" style="width: 140px; padding: 10px; font-size: 14px;">
                                <option value="1">1조</option>
                                <option value="2">2조</option>
                                <option value="3">3조</option>
                                <option value="4">4조</option>
                                <option value="5">5조</option>
                                <option value="6">6조</option>
                                <option value="7">7조</option>
                                <option value="8">8조</option>
                            </select>
                            <button id="createGroupsBtn" class="btn" style="padding: 10px 20px; font-size: 14px;">
                                <i class="fas fa-plus"></i>조 생성
                            </button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-light); margin: 12px 0 0 0;">조를 생성한 후 선수를 탭하여 배치하세요</p>
                    </div>
                </div>
                
                <!-- 등록된 선수 목록 -->
                <div class="card" style="padding: 20px; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0 0 16px 0;">
                        <i class="fas fa-users" style="color: var(--green); margin-right: 8px;"></i>
                        등록된 선수 (<span id="unassignedCount">0</span>명)
                    </h3>
                    <div id="unassignedPlayers" class="drop-zone" style="min-height: 100px; max-height: 200px; overflow-y: auto; overflow-x: hidden;">
                        <p style="margin: 0; color: var(--text-light); text-align: center; padding: 20px;">
                            조를 먼저 생성해주세요
                        </p>
                    </div>
                </div>
                
                <!-- 조편성 결과 -->
                <div class="card">
                    <div style="padding: 24px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0 0 16px 0;">
                                <i class="fas fa-layer-group" style="color: var(--green); margin-right: 8px;"></i>
                                조편성 결과
                            </h3>
                        
                        <!-- 조편성 그리드 -->
                        <div id="groupsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; overflow-x: hidden;">
                            <div class="drop-zone" style="grid-column: 1 / -1;">
                                <i class="fas fa-layer-group" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                                <p style="margin: 0;">조 개수를 설정하고 '조 생성' 버튼을 클릭하세요</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- PING PONG TME 텍스트 -->
                <div style="text-align: center; padding: 20px; color: var(--text-light); font-size: 14px; font-weight: 500;">
                    PING PONG TME
                </div>
            </div>

            <!-- 토너먼트 탭 -->
            <div id="tab-tournament" class="tab-content">
                <!-- 토너먼트 대진표 -->
                <div class="card" style="padding: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0 0 16px 0;">
                        <i class="fas fa-chess" style="color: var(--green); margin-right: 8px;"></i>
                        토너먼트 대진표
                        <span class="mobile-scroll-hint" style="display: none; font-size: 12px; color: var(--text-light); margin-left: 8px;">
                            <i class="fas fa-hand-point-left"></i> 좌우로 스크롤
                        </span>
                    </h3>
                    
                    <!-- 토너먼트 대진표 컨테이너 -->
                    <div style="background: #21355a; border-radius: 8px; padding: 14px; margin-bottom: 20px;">
                        <div class="tournament-scroll-container">
                            <div id="tournamentBoard" class="tournament-board">
                                <div class="tournament-trophy">🏆</div>
                                <div id="qbox" class="tournament-qbox">Q</div>
                                <svg id="tournamentSvg" class="tournament-bracket"></svg>
                                <div id="tournamentPlayers" class="tournament-players">
                                    <!-- 선수 박스 A~P가 동적으로 생성됩니다 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 토너먼트 제어 버튼 -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button id="startTournament" class="btn" style="margin-right: 12px;">
                            <i class="fas fa-play" style="margin-right: 8px;"></i>
                            토너먼트 시작
                        </button>
                        <button id="resetTournament" class="btn-secondary" style="display: none;">
                            <i class="fas fa-undo" style="margin-right: 8px;"></i>
                            토너먼트 초기화
                        </button>
                    </div>

                    <!-- 토너먼트 형식 표시 -->
                    <div id="tournamentFormat" style="margin-bottom: 16px; display: none;">
                        <!-- 토너먼트 형식이 동적으로 표시됩니다 -->
                    </div>

                    <!-- 토너먼트 진행 상태 -->
                    <div id="tournamentProgress" style="margin-bottom: 16px; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px; font-weight: 500; color: var(--text);">진행 상황</span>
                            <span id="tournamentRound" style="font-size: 12px; color: var(--text-light);">1라운드</span>
                        </div>
                        <div style="background: var(--gray); border-radius: 4px; height: 8px;">
                            <div id="progressBar" style="background: var(--green); height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>

                </div>
                
                <!-- 토너먼트 배정 관리 -->
                <div class="card" style="padding: 20px; margin-top: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0 0 16px 0;">
                        <i class="fas fa-users-cog" style="color: var(--green); margin-right: 8px;"></i>
                        토너먼트 배정 관리
                    </h3>
                    
                    <!-- 현재 배정 상태 -->
                    <div style="background: #f8f9fa; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="font-size: 16px; font-weight: 500; color: var(--text); margin: 0;">
                                <i class="fas fa-list" style="color: var(--green); margin-right: 8px;"></i>
                                현재 배정된 선수
                            </h4>
                            <span id="tournamentAssignedCount" style="background: var(--green); color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500;">
                                0명
                            </span>
                        </div>
                        
                        <!-- 배정된 선수 목록 -->
                        <div id="tournamentAssignedList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                            <!-- 배정된 선수들이 동적으로 생성됩니다 -->
                        </div>
                    </div>
                    
                    <!-- 배정 관리 버튼 -->
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button id="clearAllTournamentAssignments" class="btn-secondary">
                            <i class="fas fa-trash-alt" style="margin-right: 8px;"></i>
                            전체 배정 삭제
                        </button>
                        <button id="refreshTournamentDisplay" class="btn">
                            <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>
                            새로고침
                        </button>
                    </div>
                </div>
                
                <!-- PING PONG TME 텍스트 -->
                <div style="text-align: center; padding: 20px; color: var(--text-light); font-size: 14px; font-weight: 500;">
                    PING PONG TME
                </div>
            </div>

            

            <!-- 리그전 탭 -->
            <div id="tab-league" class="tab-content">
                <!-- 조별 리그전 -->
                <div class="card" style="padding: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0 0 16px 0;">
                        <i class="fas fa-medal" style="color: var(--green); margin-right: 8px;"></i>
                        조별 리그전
                    </h3>
                    
                    <!-- 조 탭 -->
                    <div class="group-tabs-container" style="border-bottom: 1px solid var(--border); margin-bottom: 20px;">
                        <div id="groupTabs" style="display: flex;">
                            <!-- 탭이 동적으로 생성됩니다 -->
                        </div>
                    </div>
                    
                    <!-- 조별 콘텐츠 -->
                    <div id="groupContent">
                        <p style="text-align: center; color: var(--text-light); padding: 40px;">
                            조를 선택하면 리그전 정보가 표시됩니다.
                        </p>
                    </div>
                </div>
                
                <!-- PING PONG TME 텍스트 -->
                <div style="text-align: center; padding: 20px; color: var(--text-light); font-size: 14px; font-weight: 500;">
                    PING PONG TME
                </div>
            </div>
        </main>
    </div>

            <!-- 토스트 -->
        <div id="toast" style="position: fixed; top: 20px; right: 20px; background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; z-index: 2000;">
            <div style="display: flex; align-items: center;">
                <i id="toastIcon" class="fas fa-check-circle" style="color: var(--green); margin-right: 8px;"></i>
                <span id="toastMessage" style="color: var(--text);">메시지</span>
            </div>
        </div>

        <!-- 조 선택 모달 -->
        <div id="groupSelectModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0;">
                        <i class="fas fa-layer-group" style="color: var(--green); margin-right: 8px;"></i>
                        <span id="selectedPlayerName">선수</span>을(를) 배치할 조를 선택하세요
                    </h3>
                    <button onclick="closeGroupSelectModal()" style="background: none; border: none; font-size: 20px; color: var(--text-light); cursor: pointer; padding: 4px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="groupSelectContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <!-- 조 선택 카드들이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>

        <!-- 대진표 선택 모달 -->
        <div id="bracketSelectModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0;">
                        <i class="fas fa-trophy" style="color: var(--green); margin-right: 8px;"></i>
                        토너먼트 대진표 선택
                    </h3>
                    <button onclick="closeBracketSelectModal()" style="background: none; border: none; font-size: 20px; color: var(--text-light); cursor: pointer; padding: 4px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 16px; color: var(--text); margin: 0;">
                        참가자 수: <span id="playerCountDisplay" style="font-weight: 600; color: var(--green);">0</span>명
                    </p>
                </div>
                <div id="bracketOptions">
                    <!-- 대진표 옵션들이 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>

        <!-- 부전승 선수 선택 모달 -->
        <div id="byeSelectionModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0;">
                        <i class="fas fa-user-check" style="color: var(--green); margin-right: 8px;"></i>
                        부전승 선수 선택
                    </h3>
                    <button onclick="closeByeSelectionModal()" style="background: none; border: none; font-size: 20px; color: var(--text-light); cursor: pointer; padding: 4px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 16px; color: var(--text); margin: 0;">
                        5명 중 <span id="byeSelectionCount" style="font-weight: 600; color: var(--green);">0</span>/3명을 부전승으로 선택하세요
                    </p>
                </div>
                <div id="byeSelectionContainer">
                    <!-- 부전승 선수 선택 카드들이 동적으로 생성됩니다 -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="confirmByeSelection" onclick="confirmByeSelection()" class="btn" disabled>
                        <i class="fas fa-check" style="margin-right: 8px;"></i>
                        부전승 선수 확정
                    </button>
                </div>
            </div>
        </div>

        <!-- 토너먼트 선수 등록 모달 -->
        <div id="tournamentPlayerRegisterModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0;">
                        <i class="fas fa-user-plus" style="color: var(--green); margin-right: 8px;"></i>
                        토너먼트 선수 등록
                    </h3>
                    <button onclick="closeTournamentPlayerRegisterModal()" style="background: none; border: none; font-size: 20px; color: var(--text-light); cursor: pointer; padding: 4px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 16px; color: var(--text); margin: 0;">
                        슬롯 <span id="selectedSlotLabel" style="font-weight: 600; color: var(--green);">A</span>에 선수를 배정하세요
                    </p>
                </div>
                <div id="tournamentPlayerList" style="max-height: 400px; overflow-y: auto;">
                    <!-- 등록된 선수 목록이 여기에 동적으로 생성됩니다 -->
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="clearTournamentSlot()" class="btn-secondary" style="margin-right: 12px;">
                        <i class="fas fa-trash" style="margin-right: 8px;"></i>
                        슬롯 비우기
                    </button>
                    <button onclick="closeTournamentPlayerRegisterModal()" class="btn">
                        <i class="fas fa-times" style="margin-right: 8px;"></i>
                        닫기
                    </button>
                </div>
            </div>
        </div>

        <!-- 4강 매칭 선택 모달 -->
        <div id="matchSelectionModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0;">
                        <i class="fas fa-handshake" style="color: var(--green); margin-right: 8px;"></i>
                        4강 매칭 선택
                    </h3>
                    <button onclick="closeMatchSelectionModal()" style="background: none; border: none; font-size: 20px; color: var(--text-light); cursor: pointer; padding: 4px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 16px; color: var(--text); margin: 0;">
                        8강 승자와 경기할 부전승 선수를 선택하세요
                    </p>
                </div>
                <div id="matchSelectionContainer">
                    <!-- 부전승 선수 선택 카드들이 동적으로 생성됩니다 -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="confirmMatchSelection" onclick="confirmMatchSelection()" class="btn" disabled>
                        <i class="fas fa-check" style="margin-right: 8px;"></i>
                        매칭 확정
                    </button>
                </div>
            </div>
        </div>

        <!-- 토너먼트 선수배정 모달 -->
        <div id="tournamentAssignModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0;">
                        <i class="fas fa-chess" style="color: var(--green); margin-right: 8px;"></i>
                        <span id="tournamentSelectedPlayerName">선수</span>을(를) 배정할 위치를 선택하세요
                    </h3>
                    <button onclick="closeTournamentAssignModal()" style="background: none; border: none; font-size: 20px; color: var(--text-light); cursor: pointer; padding: 4px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- 선수 정보 표시 -->
                <div style="background: #f8f9fa; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: var(--green); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--text); font-size: 16px;" id="modalPlayerName">선수 이름</div>
                            <div style="color: var(--text-light); font-size: 14px;" id="modalPlayerLevel">레벨</div>
                        </div>
                    </div>
                </div>

                <!-- 토너먼트 슬롯 선택 -->
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; font-weight: 500; color: var(--text); margin: 0 0 12px 0;">
                        <i class="fas fa-map-marker-alt" style="color: var(--green); margin-right: 8px;"></i>
                        배정할 위치 선택 (A~AF)
                    </h4>
                    <div id="tournamentSlotSelection" style="display: grid; grid-template-columns: repeat(16, 1fr); gap: 6px;">
                        <!-- A~AF 슬롯 버튼들이 동적으로 생성됩니다 -->
                    </div>
                </div>

                <!-- 선택된 슬롯의 상대방 정보 -->
                <div id="opponentInfo" style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-users" style="color: #4caf50; font-size: 18px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #2e7d32; font-size: 16px; margin-bottom: 4px;">
                                <span id="selectedSlotLabel">A</span> 슬롯 선택됨
                            </div>
                            <div style="color: #388e3c; font-size: 14px;" id="opponentDetails">
                                상대방: <span id="opponentName">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 현재 배정 상태 표시 -->
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle" style="color: #856404;"></i>
                        <span style="color: #856404; font-size: 14px;">
                            <span id="assignedCount">0</span>명이 배정되었습니다. (최대 32명)
                        </span>
                    </div>
                </div>

                <!-- 버튼 영역 -->
                <div style="display: flex; gap: 12px; justify-content: space-between;">
                    <div>
                        <button id="deleteTournamentAssign" class="btn-danger" style="display: none;">
                            <i class="fas fa-trash" style="margin-right: 8px;"></i>
                            배정 삭제
                        </button>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeTournamentAssignModal()" class="btn-secondary">
                            <i class="fas fa-times" style="margin-right: 8px;"></i>
                            취소
                        </button>
                        <button id="confirmTournamentAssign" class="btn" style="display: none;">
                            <i class="fas fa-check" style="margin-right: 8px;"></i>
                            배정하기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 모바일 전용 간단한 토너먼트 배정 모달 -->
        <div id="mobileSimpleAssignModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 16px; padding: 20px; max-width: 400px; width: 90%; margin: 20px;">
                <!-- 헤더 -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text); margin: 0 0 8px 0;">
                        <i class="fas fa-chess" style="color: var(--green); margin-right: 8px;"></i>
                        토너먼트 배정
                    </h3>
                    <p style="font-size: 14px; color: var(--text-light); margin: 0;">
                        <span id="mobileSimplePlayerName">선수명</span>을 어느 위치에 배정하시겠습니까?
                    </p>
                </div>

                <!-- 배정 위치 선택 -->
                <div style="margin-bottom: 20px;">
                    <div id="mobileSimpleSlotGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <!-- A~P 슬롯들이 동적으로 생성됩니다 -->
                    </div>
                </div>

                <!-- 하단 버튼 -->
                <div style="display: flex; gap: 12px;">
                    <button onclick="closeMobileSimpleAssignModal()" class="btn-secondary" style="flex: 1; padding: 12px;">
                        <i class="fas fa-times" style="margin-right: 8px;"></i>
                        취소
                    </button>
                </div>
            </div>
        </div>

        <!-- 모바일 네비게이션 -->
    <nav class="mobile-nav">
        <div class="mobile-nav-item active" onclick="switchTab('players')">
            <i class="fas fa-user-plus"></i>
            <span>선수등록</span>
        </div>
        <div class="mobile-nav-item" onclick="switchTab('groups')">
            <i class="fas fa-layer-group"></i>
            <span>조편성</span>
        </div>
        <div class="mobile-nav-item" onclick="switchTab('league')">
            <i class="fas fa-trophy"></i>
            <span>리그전</span>
        </div>
        
        <div class="mobile-nav-item" onclick="switchTab('tournament')">
            <i class="fas fa-chess"></i>
            <span>토너먼트</span>
        </div>
        <div class="mobile-nav-item">
            <i class="fas fa-chart-line"></i>
            <span>경과발표</span>
        </div>
    </nav>

    <!-- 푸터 -->
    <footer style="background: white; border-top: 1px solid var(--border); padding: 16px; text-align: center; margin-top: auto;">
        <div style="max-width: 1280px; margin: 0 auto;">
            <p style="margin: 0; color: var(--text-light); font-size: 14px; font-weight: 500;">
                PING PONG TME
            </p>
        </div>
    </footer>

    <!-- 경기 정보 모달 -->
    <div id="matchInfoModal" class="match-info-modal">
        <div class="match-info-content">
            <div class="match-info-header">
                <h3 class="match-info-title">경기 정보</h3>
                <button class="close-match-info" onclick="closeMatchInfoModal()">&times;</button>
            </div>
            <div class="match-details">
                <div class="match-round" id="matchRoundInfo"></div>
                <div class="match-players">
                    <div class="match-player" id="matchPlayer1" onclick="selectMatchWinner(1)">
                        <div class="player-name" id="player1Name"></div>
                        <div class="player-slot" id="player1Slot"></div>
                    </div>
                    <div class="match-vs">VS</div>
                    <div class="match-player" id="matchPlayer2" onclick="selectMatchWinner(2)">
                        <div class="player-name" id="player2Name"></div>
                        <div class="player-slot" id="player2Slot"></div>
                    </div>
                </div>
                <div class="match-actions">
                    <button class="btn-confirm" id="confirmWinnerBtn" onclick="confirmMatchWinner()" disabled>
                        승자 확정
                    </button>
                    <button class="btn-cancel" onclick="closeMatchInfoModal()">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수 최소화
        const state = {
            players: [],
            groups: [],
            leagueResults: {},
            gameFormat: '5-3',
            currentGroupIndex: 0,
            isLoading: false,
            currentTab: 'players',
            history: [],
            historyIndex: -1,
            isCompleted: false
        };

        const elements = {};
        const STORAGE_KEY = 'tournament_players';

        // DOM 요소 캐싱
        function initElements() {
            const ids = ['nameInput', 'levelSelect', 'addBtn', 'playersList', 'playerCount', 
                        'totalPlayers', 'totalGroups', 'totalMatches', 'resetBtn', 
                        'toast', 'toastMessage', 'toastIcon', 'emptyRow',
                        'groupCount', 'createGroupsBtn', 'groupsContainer', 'unassignedPlayers', 'unassignedCount',
                        'groupSelectModal', 'selectedPlayerName', 'groupSelectContainer',
                        'tournamentAssignModal', 'tournamentSelectedPlayerName', 'modalPlayerName', 'modalPlayerLevel',
                        'tournamentSlotSelection', 'assignedCount', 'confirmTournamentAssign', 'deleteTournamentAssign',
                        'opponentInfo', 'selectedSlotLabel', 'opponentName',
                        'tournamentAssignedCount', 'tournamentAssignedList', 'clearAllTournamentAssignments', 'refreshTournamentDisplay',
                        'gameFormat', 'groupTabs', 'groupContent',
                        'integratedSaveBtn', 'integratedLoadBtn'];
            
            ids.forEach(id => {
                elements[id] = document.getElementById(id);
                if (!elements[id]) console.warn(`Element not found: ${id}`);
            });
        }

        // 유틸리티 함수
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function validatePlayerName(name) {
            if (!name || name.length === 0) return '선수 이름을 입력해주세요.';
            if (name.length > 20) return '선수 이름은 20자 이내로 입력해주세요.';
            if (state.players.some(p => p.name === name)) return '이미 등록된 선수입니다.';
            return null;
        }

        // 토스트 메시지
        function showToast(message, type = 'success') {
            if (state.isLoading) return;
            
            elements.toastMessage.textContent = message;
            
            if (type === 'error') {
                elements.toastIcon.className = 'fas fa-exclamation-circle';
                elements.toastIcon.style.color = '#dc2626';
            } else if (type === 'info') {
                elements.toastIcon.className = 'fas fa-info-circle';
                elements.toastIcon.style.color = '#3b82f6';
            } else {
                elements.toastIcon.className = 'fas fa-check-circle';
                elements.toastIcon.style.color = 'var(--green)';
            }
            
            elements.toast.style.display = 'block';
            
            setTimeout(() => {
                elements.toast.style.display = 'none';
            }, 3000);
        }

        // 통계 업데이트
        function updateStats() {
            const count = state.players.length;
            elements.playerCount.textContent = count;
            elements.totalPlayers.textContent = count;
            elements.totalGroups.textContent = Math.ceil(count / 4);
            // 예상 경기수 계산 (조별 토너먼트 방식)
            const groups = Math.ceil(count / 4);
            const matchesPerGroup = 6; // 4명이 한 조일 때 조별 경기수
            elements.totalMatches.textContent = groups * matchesPerGroup;
        }

        // 선수 목록 렌더링 (성능 최적화)
        function renderPlayers() {
            const tbody = elements.playersList;
            const fragment = document.createDocumentFragment();
            
            // 기존 행 제거 (emptyRow 제외)
            Array.from(tbody.children).forEach(row => {
                if (row.id !== 'emptyRow') row.remove();
            });

            if (state.players.length === 0) {
                elements.emptyRow.style.display = 'table-row';
            } else {
                elements.emptyRow.style.display = 'none';
                
                state.players.forEach((player, index) => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--border)';
                    row.innerHTML = `
                        <td style="padding: 12px;">
                            <span class="editable" onclick="editName(${index})" data-name="${index}">${player.name}</span>
                        </td>
                        <td style="padding: 12px;">
                            <span class="editable" onclick="editLevel(${index})" data-level="${index}">
                                <span class="badge">${player.level}</span>
                            </span>
                        </td>
                        <td style="padding: 12px;">
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editPlayer(${index})" style="color: var(--green); background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 4px; touch-action: manipulation;" 
                                        onmouseover="this.style.background='var(--green-light)'" onmouseout="this.style.background='none'">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deletePlayer(${index})" style="color: #dc2626; background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 4px; touch-action: manipulation;" 
                                        onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    fragment.appendChild(row);
                });
            }
            
            tbody.appendChild(fragment);
            updateStats();
        }

        // 선수 추가
        function addPlayer() {
            if (state.isLoading) return;
            
            const name = elements.nameInput.value.trim();
            const level = elements.levelSelect.value;
            
            const error = validatePlayerName(name);
            if (error) {
                showToast(error, 'error');
                elements.nameInput.focus();
                return;
            }
            
            state.players.push({
                id: Date.now(),
                name,
                level
            });
            
            elements.nameInput.value = '';
            elements.levelSelect.value = '1부';
            elements.nameInput.focus();
            
            renderPlayers();
            saveToStorage();
            
            // 조편성과 리그전 데이터 유지 (자동 저장)
            if (state.groups.length > 0) {
                saveGroupsToStorage();
            }
            if (state.leagueResults && Object.keys(state.leagueResults).length > 0) {
                saveLeagueDataToStorage();
            }
            
            // 조편성 탭이 활성화되어 있으면 화면 업데이트
            if (state.currentTab === 'groups') {
                renderGroups();
                renderUnassignedPlayers();
            }
            
            showToast(`${name} 선수가 등록되었습니다.`);
        }

        // 간단한 이름 편집
        function editName(index) {
            if (state.isLoading) return;
            
            const player = state.players[index];
            const newName = prompt('선수 이름을 수정하세요:', player.name);
            
            if (newName === null) return; // 취소
            
            const trimmedName = newName.trim();
            if (!trimmedName) {
                showToast('선수 이름을 입력해주세요.', 'error');
                return;
            }
            
            if (trimmedName.length > 20) {
                showToast('선수 이름은 20자 이내로 입력해주세요.', 'error');
                return;
            }
            
            if (state.players.some((p, i) => i !== index && p.name === trimmedName)) {
                showToast('이미 등록된 선수입니다.', 'error');
                return;
            }
            
            const oldName = player.name;
            player.name = trimmedName;
            
            renderPlayers();
            saveToStorage();
            showToast(`${oldName} → ${trimmedName}으로 변경되었습니다.`);
        }
        
        // 간단한 부수 편집
        function editLevel(index) {
            if (state.isLoading) return;
            
            const player = state.players[index];
            const levels = ['1부', '2부', '3부', '4부', '5부', '6부', '7부', '8부', '9부', '10부'];
            const currentIndex = levels.indexOf(player.level);
            
            const newLevel = prompt('부수를 선택하세요 (1-10):', currentIndex + 1);
            
            if (newLevel === null) return; // 취소
            
            const levelNum = parseInt(newLevel);
            if (isNaN(levelNum) || levelNum < 1 || levelNum > 10) {
                showToast('1부터 10까지의 숫자를 입력해주세요.', 'error');
                return;
            }
            
            const newLevelText = `${levelNum}부`;
            const oldLevel = player.level;
            player.level = newLevelText;
            
            renderPlayers();
            saveToStorage();
            showToast(`${player.name} 선수의 부수가 ${oldLevel} → ${newLevelText}으로 변경되었습니다.`);
        }

        // 선수 수정 (기존 모달 방식)
        function editPlayer(index) {
            if (state.isLoading) return;
            
            const player = state.players[index];
            
            // 수정 모달 생성
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 3000; 
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; width: 100%; max-width: 400px;">
                    <h3 style="margin: 0 0 20px 0; color: var(--text); font-size: 18px;">
                        <i class="fas fa-edit" style="color: var(--green); margin-right: 8px;"></i>
                        선수 정보 수정
                    </h3>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text);">선수 이름</label>
                        <input type="text" id="editNameInput" value="${player.name}" 
                               style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 16px;"
                               maxlength="20">
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text);">부수</label>
                        <select id="editLevelSelect" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 16px;">
                            <option value="1부" ${player.level === '1부' ? 'selected' : ''}>1부</option>
                            <option value="2부" ${player.level === '2부' ? 'selected' : ''}>2부</option>
                            <option value="3부" ${player.level === '3부' ? 'selected' : ''}>3부</option>
                            <option value="4부" ${player.level === '4부' ? 'selected' : ''}>4부</option>
                            <option value="5부" ${player.level === '5부' ? 'selected' : ''}>5부</option>
                            <option value="6부" ${player.level === '6부' ? 'selected' : ''}>6부</option>
                            <option value="7부" ${player.level === '7부' ? 'selected' : ''}>7부</option>
                            <option value="8부" ${player.level === '8부' ? 'selected' : ''}>8부</option>
                            <option value="9부" ${player.level === '9부' ? 'selected' : ''}>9부</option>
                            <option value="10부" ${player.level === '10부' ? 'selected' : ''}>10부</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="cancelEdit" class="btn-secondary" style="padding: 10px 16px;">취소</button>
                        <button id="saveEdit" class="btn" style="padding: 10px 16px;">저장</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const nameInput = modal.querySelector('#editNameInput');
            const levelSelect = modal.querySelector('#editLevelSelect');
            const cancelBtn = modal.querySelector('#cancelEdit');
            const saveBtn = modal.querySelector('#saveEdit');
            
            // 포커스 및 선택
            setTimeout(() => {
                nameInput.focus();
                nameInput.select();
            }, 100);
            
            // 취소 버튼
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 모달 외부 클릭 시 취소
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 저장 버튼
            saveBtn.addEventListener('click', () => {
                const newName = nameInput.value.trim();
                const newLevel = levelSelect.value;
                
                if (!newName) {
                    showToast('선수 이름을 입력해주세요.', 'error');
                    nameInput.focus();
                    return;
                }
                
                if (newName.length > 20) {
                    showToast('선수 이름은 20자 이내로 입력해주세요.', 'error');
                    nameInput.focus();
                    return;
                }
                
                // 중복 체크 (자기 자신 제외)
                if (state.players.some((p, i) => i !== index && p.name === newName)) {
                    showToast('이미 등록된 선수입니다.', 'error');
                    nameInput.focus();
                    return;
                }
                
                const oldName = player.name;
                player.name = newName;
                player.level = newLevel;
                
                document.body.removeChild(modal);
                renderPlayers();
                saveToStorage();
                showToast(`${oldName} 선수 정보가 수정되었습니다.`);
            });
            
            // Enter 키로 저장
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveBtn.click();
                }
            });
            
            levelSelect.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveBtn.click();
                }
            });
        }

        // 선수 삭제
        function deletePlayer(index) {
            if (state.isLoading || !confirm('정말로 삭제하시겠습니까?')) return;
            
            const playerName = state.players[index].name;
            state.players.splice(index, 1);
            renderPlayers();
            saveToStorage();
            
            // 조편성과 리그전 데이터 유지 (자동 저장)
            if (state.groups.length > 0) {
                saveGroupsToStorage();
            }
            if (state.leagueResults && Object.keys(state.leagueResults).length > 0) {
                saveLeagueDataToStorage();
            }
            
            // 조편성 탭이 활성화되어 있으면 화면 업데이트
            if (state.currentTab === 'groups') {
                renderGroups();
                renderUnassignedPlayers();
            }
            
            showToast(`${playerName} 선수가 삭제되었습니다.`);
        }

        // 로컬스토리지 처리
        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.players));
            } catch (e) {
                console.error('Storage save failed:', e);
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    state.players = JSON.parse(data);
                    renderPlayers();
                }
            } catch (e) {
                console.error('Storage load failed:', e);
                state.players = [];
            }
        }

        // 통합 데이터 저장 (모든 데이터 포함)
        function saveIntegratedData() {
            if (state.isLoading) return;
            
            // 파일명 입력 받기
            const defaultName = `tournament_${new Date().toISOString().split('T')[0]}`;
            const fileName = prompt('저장할 파일명을 입력하세요:', defaultName);
            
            if (fileName === null) return; // 취소된 경우
            
            if (!fileName.trim()) {
                showToast('파일명을 입력해주세요.', 'error');
                return;
            }
            
            try {
                const data = {
                    players: state.players,
                    groups: state.groups,
                    leagueResults: state.leagueResults,
                    gameFormat: state.gameFormat,
                    timestamp: new Date().toISOString()
                };
                
                const jsonData = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName.endsWith('.json') ? fileName : `${fileName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('모든 데이터가 저장되었습니다.');
            } catch (e) {
                showToast('저장 중 오류가 발생했습니다.', 'error');
            }
        }

        // 통합 데이터 불러오기 (모든 데이터 포함)
        function loadIntegratedData() {
            if (state.isLoading) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // 선수 데이터
                        if (data.players) {
                            state.players = data.players;
                            renderPlayers();
                            saveToStorage();
                        }
                        
                        // 조편성 데이터
                        if (data.groups) {
                            state.groups = data.groups;
                            saveGroupsToStorage();
                        }
                        
                        // 리그전 데이터
                        if (data.leagueResults) {
                            state.leagueResults = data.leagueResults;
                        }
                        if (data.gameFormat) {
                            state.gameFormat = data.gameFormat;
                            if (elements.gameFormat) {
                                elements.gameFormat.value = data.gameFormat;
                            }
                        }
                        
                        // 화면 업데이트
                        if (state.currentTab === 'groups') {
                            renderGroups();
                            renderUnassignedPlayers();
                        } else if (state.currentTab === 'league') {
                            renderLeagueTab();
                        }
                        
                        saveLeagueDataToStorage();
                        showToast('모든 데이터가 불러와졌습니다.');
                    } catch (e) {
                        showToast('파일을 읽을 수 없습니다.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 기존 선수 데이터 저장 (호환성 유지)
        function saveData() {
            if (state.isLoading) return;
            
            // 파일명 입력 받기
            const defaultName = `players_${new Date().toISOString().split('T')[0]}`;
            const fileName = prompt('저장할 파일명을 입력하세요:', defaultName);
            
            if (fileName === null) return; // 취소된 경우
            
            if (!fileName.trim()) {
                showToast('파일명을 입력해주세요.', 'error');
                return;
            }
            
            try {
                const data = JSON.stringify(state.players, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName.endsWith('.json') ? fileName : `${fileName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('데이터가 저장되었습니다.');
            } catch (e) {
                showToast('저장 중 오류가 발생했습니다.', 'error');
            }
        }

        function loadData() {
            if (state.isLoading) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error('Invalid format');
                        
                        state.players = data;
                        renderPlayers();
                        saveToStorage();
                        showToast('데이터가 불러와졌습니다.');
                    } catch (e) {
                        showToast('파일을 읽을 수 없습니다.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetData() {
            if (state.isLoading || !confirm('모든 데이터(선수, 조편성, 리그전)를 삭제하시겠습니까?')) return;
            
            // 모든 데이터 초기화
            state.players = [];
            state.groups = [];
            state.leagueResults = [];
            state.currentTab = 'players';
            state.currentGroupIndex = 0;
            state.history = [];
            state.historyIndex = -1;
            state.isCompleted = false;
            
            // 모든 localStorage 데이터 삭제
            localStorage.removeItem('players_data');
            localStorage.removeItem('groups_data');
            localStorage.removeItem('league_data');
            
            // 화면 초기화
            renderPlayers();
            if (state.currentTab === 'groups') {
                renderGroups();
                renderUnassignedPlayers();
            } else if (state.currentTab === 'league') {
                renderEmptyLeague();
            }
            
            showToast('모든 데이터가 초기화되었습니다.');
        }

        // 이벤트 리스너 등록 (디바운스 적용)
        function initEvents() {
            elements.addBtn.addEventListener('click', addPlayer);
            elements.nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPlayer();
                }
            });
            
            // 입력 검증 디바운스
            elements.nameInput.addEventListener('input', debounce((e) => {
                const error = validatePlayerName(e.target.value.trim());
                e.target.style.borderColor = error ? '#dc2626' : 'var(--border)';
            }, 300));
            
            elements.integratedSaveBtn.addEventListener('click', saveIntegratedData);
            elements.integratedLoadBtn.addEventListener('click', loadIntegratedData);
            elements.resetBtn.addEventListener('click', resetData);
            
            // 키보드 단축키
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveIntegratedData();
                }
            });

            // 윈도우 리사이즈 이벤트 (토너먼트 대진표 다시 그리기)
            window.addEventListener('resize', handleTournamentResize);

            // 토너먼트 설정 관련 이벤트
            const saveTournamentBtn = document.getElementById('saveTournamentAssignments');
            const clearTournamentBtn = document.getElementById('clearTournamentAssignments');
            
            if (saveTournamentBtn) {
                saveTournamentBtn.addEventListener('click', saveTournamentAssignments);
            }
            if (clearTournamentBtn) {
                clearTournamentBtn.addEventListener('click', clearTournamentAssignments);
            }

            // 토너먼트 탭 배정 관리 이벤트
            const clearAllBtn = document.getElementById('clearAllTournamentAssignments');
            const refreshBtn = document.getElementById('refreshTournamentDisplay');
            
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', clearAllTournamentAssignments);
            }
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshTournamentDisplay);
            }

            // 토너먼트 경기 관리 이벤트
            const startTournamentBtn = document.getElementById('startTournament');
            const resetTournamentBtn = document.getElementById('resetTournament');
            
            if (startTournamentBtn) {
                startTournamentBtn.addEventListener('click', startTournament);
            }
            if (resetTournamentBtn) {
                resetTournamentBtn.addEventListener('click', resetTournament);
            }
        }

        // 탭 전환 함수
        function switchTab(tabName) {
            // 모든 탭 콘텐츠 숨기기
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // 모든 네비게이션 버튼 비활성화
            document.querySelectorAll('.mobile-nav-item').forEach(btn => {
                btn.classList.remove('active');
            });

            // 선택된 탭 활성화
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');

            state.currentTab = tabName;

            // 헤더 제목 변경
            const headerTitle = document.querySelector('header h1');
            if (tabName === 'players') {
                headerTitle.innerHTML = '<i class="fas fa-user-plus" style="color: var(--green); margin-right: 8px;"></i>선수등록';
            } else if (tabName === 'groups') {
                headerTitle.innerHTML = '<i class="fas fa-layer-group" style="color: var(--green); margin-right: 8px;"></i>조편성';
            } else if (tabName === 'league') {
                headerTitle.innerHTML = '<i class="fas fa-trophy" style="color: var(--green); margin-right: 8px;"></i>리그전';
            } else if (tabName === 'tournament') {
                headerTitle.innerHTML = '<i class="fas fa-chess" style="color: var(--green); margin-right: 8px;"></i>토너먼트';
            }

            // 탭별 초기화 함수 호출
            if (tabName === 'groups') {
                initGroupsTab();
            } else if (tabName === 'league') {
                initLeagueTab();
            } else if (tabName === 'tournament') {
                initTournamentTab();
            }
        }

        // 조편성 탭 초기화
        function initGroupsTab() {
            // 조편성 데이터 로드 (기존 데이터 유지)
            loadGroupsFromStorage();
            renderGroups();
            renderUnassignedPlayers();
            initGroupEvents();
        }

        // 리그전 탭 초기화
        function initLeagueTab() {
            // 조편성 데이터 로드
            loadGroupsFromStorage();
            
            // 조편성이 완료되지 않은 경우 빈 화면 표시
            if (state.groups.length === 0 || !isGroupingCompleted()) {
                renderEmptyLeague();
                return;
            }
            
            // 리그전 데이터 로드 (자동으로)
            loadLeagueDataFromStorage();
            
            // 리그전 데이터가 없으면 자동 생성
            if (!state.leagueResults || state.leagueResults.length === 0) {
                generateLeagueData();
            }
            
            // 리그전 화면 렌더링
            renderLeagueTab();
            
            // 리그전 이벤트 초기화
            initLeagueEvents();
        }

        // 조편성 완료 확인
        function isGroupingCompleted() {
            if (state.groups.length === 0) return false;
            
            const totalPlayers = state.groups.reduce((sum, group) => sum + group.players.length, 0);
            return totalPlayers === state.players.length;
        }

        // 빈 리그전 화면 렌더링
        function renderEmptyLeague() {
            elements.groupTabs.innerHTML = '';
            elements.groupContent.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">조편성을 먼저 완료해주세요.</p>';
        }

        // 리그전 탭 렌더링
        function renderLeagueTab() {
            renderGroupTabs();
            renderGroupContent();
        }

        // 조 탭 렌더링
        function renderGroupTabs() {
            if (!state.groups || state.groups.length === 0) {
                elements.groupTabs.innerHTML = '';
                return;
            }

            let html = '';
            state.groups.forEach((group, index) => {
                if (group.players && group.players.length > 0) {
                    const isActive = index === state.currentGroupIndex ? 'active' : '';
                    const isCompleted = isGroupCompleted(index);
                    const completedIcon = isCompleted ? ' ✓' : '';
                    
                    html += `
                        <button class="group-tab ${isActive}" onclick="switchToGroup(${index})" style="padding: 12px 20px; border: none; background: none; border-bottom: 2px solid transparent; color: var(--text-light); font-weight: 500; cursor: pointer; transition: all 0.2s ease; white-space: nowrap;">
                            ${index + 1}조 (${group.players.length}명)${completedIcon}
                        </button>
                    `;
                }
            });

            elements.groupTabs.innerHTML = html;
        }

        // 조 완료 확인
        function isGroupCompleted(groupIndex) {
            if (!state.groups[groupIndex] || !state.groups[groupIndex].players) {
                return false;
            }

            const players = state.groups[groupIndex].players;
            const totalMatches = (players.length * (players.length - 1)) / 2;
            let completedMatches = 0;

            // 각 선수별로 완료된 경기 수 계산
            players.forEach(player => {
                const playerId = player.id;
                players.forEach(opponent => {
                    if (opponent.id !== playerId) {
                        const matchResult = getMatchResult(playerId, opponent.id);
                        if (matchResult.score !== '-') {
                            completedMatches++;
                        }
                    }
                });
            });

            // 중복 제거 (A vs B와 B vs A는 같은 경기)
            completedMatches = completedMatches / 2;
            return completedMatches >= totalMatches;
        }

        // 조 전환
        function switchToGroup(groupIndex) {
            if (groupIndex >= 0 && state.groups[groupIndex]) {
                state.currentGroupIndex = groupIndex;
                renderGroupTabs();
                renderGroupContent();
            }
        }

        // 조별 콘텐츠 렌더링
        function renderGroupContent() {
            if (!state.groups[state.currentGroupIndex] || !state.groups[state.currentGroupIndex].players) {
                elements.groupContent.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">조를 선택하면 리그전 정보가 표시됩니다.</p>';
                return;
            }

            const group = state.groups[state.currentGroupIndex];
            const groupName = `${state.currentGroupIndex + 1}조`;
            const groupData = state.leagueResults[state.currentGroupIndex];
            
            // 조 통계 계산
            const totalPlayers = group.players.length;
            const totalMatches = (totalPlayers * (totalPlayers - 1)) / 2;
            let completedMatches = 0;
            if (groupData && groupData.matches) {
                completedMatches = groupData.matches.filter(match => match.score !== '-').length;
            }
            const remainingMatches = totalMatches - completedMatches;

            let html = `
                <!-- 조 정보 (컴팩트) -->
                <div style="background: var(--gray); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h4 style="margin: 0; color: var(--text); font-size: 16px;">${groupName} (${totalPlayers}명)</h4>
                        <span style="background: var(--green); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500;">
                            <i class="fas fa-users" style="margin-right: 2px;"></i>${totalPlayers}명
                        </span>
                    </div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="font-size: 14px; font-weight: bold; color: var(--green);">${completedMatches}</div>
                            <div style="font-size: 11px; color: var(--text-light);">완료</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; font-weight: bold; color: var(--green);">${totalMatches}</div>
                            <div style="font-size: 11px; color: var(--text-light);">총 경기</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; font-weight: bold; color: var(--green);">${remainingMatches}</div>
                            <div style="font-size: 11px; color: var(--text-light);">남은 경기</div>
                        </div>
                    </div>
                </div>

                <!-- 경기 결과 입력 (컴팩트) -->
                <div style="margin-bottom: 16px;">
                    <h4 style="font-size: 15px; font-weight: 600; color: var(--text); margin: 0 0 12px 0;">
                        <i class="fas fa-edit" style="color: var(--green); margin-right: 6px;"></i>
                        경기 결과 입력
                    </h4>
                    <div id="matchContainer">
                        ${renderMatchesForGroup()}
                    </div>
                </div>

                <!-- 순위표 (컴팩트) -->
                <div>
                    <h4 style="font-size: 15px; font-weight: 600; color: var(--text); margin: 0 0 12px 0;">
                        <i class="fas fa-medal" style="color: var(--green); margin-right: 6px;"></i>
                        순위표
                    </h4>
                    <div id="rankingContainer">
                        ${renderRankingForGroup()}
                    </div>
                </div>
            `;

            elements.groupContent.innerHTML = html;
        }

        // 조별 경기 렌더링
        function renderMatchesForGroup() {
            const groupData = state.leagueResults[state.currentGroupIndex];
            if (!groupData || !groupData.matches) {
                return '<p style="text-align: center; color: var(--text-light); padding: 20px;">경기 데이터가 없습니다.</p>';
            }

            const matches = groupData.matches;
            const groupName = `${state.currentGroupIndex + 1}조`;

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="color: var(--text-light); font-size: 13px;">총 ${matches.length}경기</span>
                </div>
            `;

            matches.forEach((match, index) => {
                const isCompleted = match.score !== '-';
                const isCurrent = !isCompleted && index === 0;
                
                // 점수 분리 (개별 점수 우선)
                let score1 = match.score1 || '';
                let score2 = match.score2 || '';
                
                // 개별 점수가 없으면 기존 점수에서 분리
                if (!score1 && !score2 && match.score !== '-' && match.score.includes('-')) {
                    const scores = match.score.split('-');
                    score1 = scores[0] || '';
                    score2 = scores[1] || '';
                }
                
                html += `
                    <div class="match-card ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}" style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                        <div class="match-players" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div class="player-info" style="display: flex; align-items: center; gap: 6px; flex: 1;">
                                <span class="player-name" style="font-weight: 500; font-size: 14px;">${match.player1.name}</span>
                                <span class="player-level" style="background: var(--green); color: white; padding: 1px 6px; border-radius: 10px; font-size: 11px;">${match.player1.level}</span>
                            </div>
                            <div class="score-inputs" style="display: flex; align-items: center; gap: 6px;">
                                <input type="number" class="score-input" value="${score1}" 
                                       onchange="updateMatchScore(${index}, 'player1', this.value)" 
                                       placeholder="0" min="0" max="9" 
                                       style="width: 40px; padding: 4px 6px; border: 1px solid var(--border); border-radius: 4px; text-align: center; font-size: 13px;">
                                <span style="font-weight: bold; color: var(--text-light); font-size: 14px;">vs</span>
                                <input type="number" class="score-input" value="${score2}" 
                                       onchange="updateMatchScore(${index}, 'player2', this.value)" 
                                       placeholder="0" min="0" max="9"
                                       style="width: 40px; padding: 4px 6px; border: 1px solid var(--border); border-radius: 4px; text-align: center; font-size: 13px;">
                            </div>
                            <div class="player-info" style="display: flex; align-items: center; gap: 6px; flex: 1; justify-content: flex-end;">
                                <span class="player-level" style="background: var(--green); color: white; padding: 1px 6px; border-radius: 10px; font-size: 11px;">${match.player2.level}</span>
                                <span class="player-name" style="font-weight: 500; font-size: 14px;">${match.player2.name}</span>
                            </div>
                        </div>
                        ${isCompleted ? `
                            <div style="text-align: center; color: var(--text-light); font-size: 11px;">
                                <i class="fas fa-check-circle" style="color: var(--green); margin-right: 3px;"></i>
                                ${match.winner === match.player1.id ? match.player1.name : match.player2.name} 승리
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            return html;
        }

        // 조별 순위 렌더링
        function renderRankingForGroup() {
            const players = state.groups[state.currentGroupIndex].players;
            const rankings = calculateRankings(players);
            const groupName = `${state.currentGroupIndex + 1}조`;
            const isCompleted = isGroupCompleted(state.currentGroupIndex);

            // 헤더 생성 (모바일 최적화)
            let headerHtml = '<th>번호</th><th>선수명</th><th>부수</th>';
            players.forEach(player => {
                // 모바일에서 선수명이 너무 길면 줄임
                const displayName = player.name.length > 4 ? player.name.substring(0, 4) + '...' : player.name;
                headerHtml += `<th title="${player.name}">${displayName}</th>`;
            });
            headerHtml += '<th>승/패</th><th>승점</th><th>득실률</th><th>순위</th>';

            // 테이블 생성 (컴팩트)
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="color: var(--text-light); font-size: 13px;">${groupName} 순위표</span>
                    ${isCompleted ? 
                        '<span style="background: var(--green); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500;"><i class="fas fa-check" style="margin-right: 2px;"></i>완료</span>' : 
                        '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500;"><i class="fas fa-clock" style="margin-right: 2px;"></i>진행중</span>'
                    }
                </div>
                <div class="ranking-scroll-container">
                    <table class="ranking-table" style="min-width: 500px;">
                        <thead>
                            <tr>${headerHtml}</tr>
                        </thead>
                        <tbody>
            `;

            // 조편성 순서대로 선수 표시 (순위는 별도 계산)
            players.forEach((player, playerIndex) => {
                // 해당 선수의 순위 정보 찾기
                const playerRanking = rankings.find(r => r.id === player.id);
                const rankIndex = rankings.findIndex(r => r.id === player.id);
                const rankClass = rankIndex < 3 ? `rank-${rankIndex + 1}` : '';
                const winLoss = `${playerRanking.wins}승 ${playerRanking.losses}패`;
                const goalRatio = playerRanking.goalRatio;
                
                html += `
                    <tr>
                        <td style="white-space: nowrap; font-size: 12px;">${playerIndex + 1}</td>
                        <td class="${rankClass}" style="white-space: nowrap; font-size: 12px;">${player.name}</td>
                        <td style="white-space: nowrap;"><span class="badge" style="background: var(--green); color: white; padding: 1px 6px; border-radius: 10px; font-size: 11px;">${player.level}</span></td>
                `;
                
                // 상대전적 표시 (개별 점수) - 조편성 순서대로
                players.forEach(opponent => {
                    if (opponent.id === player.id) {
                        html += '<td style="text-align: center; color: var(--text-light); white-space: nowrap; font-size: 11px;">-</td>';
                    } else {
                        const playerScore = getPlayerScore(player.id, opponent.id);
                        if (playerScore === '') {
                            html += '<td style="text-align: center; white-space: nowrap; font-size: 11px;"></td>';
                        } else {
                            const matchResult = getMatchResult(player.id, opponent.id);
                            const resultClass = matchResult.winner === player.id ? 'win' : 
                                              matchResult.winner === opponent.id ? 'lose' : 'pending';
                            html += `<td class="match-result ${resultClass}" style="text-align: center; font-weight: 500; white-space: nowrap; font-size: 11px;">${playerScore}</td>`;
                        }
                    }
                });
                
                html += `
                        <td style="white-space: nowrap; font-size: 11px;">${winLoss}</td>
                        <td style="white-space: nowrap; font-size: 11px;">${playerRanking.points}</td>
                        <td style="white-space: nowrap; font-size: 11px;">${goalRatio}</td>
                        <td class="${rankClass}" style="white-space: nowrap; font-size: 12px; font-weight: bold;">${rankIndex + 1}위</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }


        // 순위 계산
        function calculateRankings(players) {
            const rankings = players.map(player => {
                let wins = 0;
                let losses = 0;
                let points = 0;
                let totalMatches = 0;
                let goalsFor = 0; // 득점
                let goalsAgainst = 0; // 실점

                players.forEach(opponent => {
                    if (opponent.id !== player.id) {
                        const matchResult = getMatchResult(player.id, opponent.id);
                        if (matchResult.score !== '-') {
                            totalMatches++;
                            
                            // 득점과 실점 계산
                            const playerScore = getPlayerScore(player.id, opponent.id);
                            const opponentScore = getPlayerScore(opponent.id, player.id);
                            
                            if (playerScore !== '' && opponentScore !== '') {
                                const playerScoreNum = parseInt(playerScore) || 0;
                                const opponentScoreNum = parseInt(opponentScore) || 0;
                                
                                goalsFor += playerScoreNum;
                                goalsAgainst += opponentScoreNum;
                            }
                            
                            if (matchResult.winner === player.id) {
                                wins++;
                                points += 3; // 승리 시 3점
                            } else if (matchResult.winner === opponent.id) {
                                losses++;
                            } else {
                                points += 1; // 무승부 시 1점
                            }
                        }
                    }
                });

                const winRate = totalMatches > 0 ? wins / totalMatches : 0;
                const goalRatio = goalsAgainst > 0 ? (goalsFor / goalsAgainst).toFixed(2) : (goalsFor > 0 ? '∞' : '0.00');

                return {
                    ...player,
                    wins,
                    losses,
                    points,
                    totalMatches,
                    winRate,
                    goalsFor,
                    goalsAgainst,
                    goalRatio
                };
            });

            // 순위 정렬 (승점 > 득실률 > 승수)
            return rankings.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalRatio !== a.goalRatio) return parseFloat(b.goalRatio) - parseFloat(a.goalRatio);
                return b.wins - a.wins;
            });
        }

        // 경기 결과 가져오기
        function getMatchResult(player1Id, player2Id) {
            const groupData = state.leagueResults[state.currentGroupIndex];
            if (!groupData || !groupData.matches) {
                return { score: '-', winner: null };
            }

            const match = groupData.matches.find(m => 
                (m.player1.id === player1Id && m.player2.id === player2Id) ||
                (m.player1.id === player2Id && m.player2.id === player1Id)
            );

            return match ? { score: match.score, winner: match.winner } : { score: '-', winner: null };
        }

        // 선수별 개별 점수 가져오기
        function getPlayerScore(playerId, opponentId) {
            const groupData = state.leagueResults[state.currentGroupIndex];
            if (!groupData || !groupData.matches) {
                return '';
            }

            const match = groupData.matches.find(m => 
                (m.player1.id === playerId && m.player2.id === opponentId) ||
                (m.player1.id === opponentId && m.player2.id === playerId)
            );

            if (!match) return '';

            // 해당 선수의 점수 반환
            if (match.player1.id === playerId) {
                return match.score1 || '';
            } else if (match.player2.id === playerId) {
                return match.score2 || '';
            }

            return '';
        }


        // 경기 점수 업데이트 (개별 점수 입력)
        function updateMatchScore(matchIndex, player, value) {
            const groupData = state.leagueResults[state.currentGroupIndex];
            if (!groupData || !groupData.matches[matchIndex]) return;

            const match = groupData.matches[matchIndex];
            const score1 = player === 'player1' ? value : (match.score1 || '');
            const score2 = player === 'player2' ? value : (match.score2 || '');
            
            // 점수 저장 (문자열로 저장)
            match.score1 = score1.toString();
            match.score2 = score2.toString();
            
            // 점수가 모두 입력되었는지 확인
            if (score1 !== '' && score2 !== '') {
                const num1 = parseInt(score1);
                const num2 = parseInt(score2);
                
                if (!isNaN(num1) && !isNaN(num2)) {
                    // 승자 결정 (무승부 없음)
                    if (num1 > num2) {
                        match.winner = match.player1.id;
                    } else if (num2 > num1) {
                        match.winner = match.player2.id;
                    }
                    
                    // 점수 문자열 생성
                    match.score = `${num1}-${num2}`;
                }
            } else {
                // 점수가 완전하지 않으면 초기화
                match.score = '-';
                match.winner = null;
            }

            // 화면 업데이트
            renderGroupContent();
            
            // 데이터 저장
            saveLeagueDataToStorage();
        }

        // 경기 결과 업데이트 (기존 함수 - 호환성 유지)
        function updateMatchResult(matchIndex, score) {
            const groupData = state.leagueResults[state.currentGroupIndex];
            if (!groupData || !groupData.matches[matchIndex]) return;

            const match = groupData.matches[matchIndex];
            match.score = score;
            
            // 승자 결정
            if (score !== '-' && score.includes('-')) {
                const [score1, score2] = score.split('-').map(s => parseInt(s.trim()));
                if (!isNaN(score1) && !isNaN(score2)) {
                    if (score1 > score2) {
                        match.winner = match.player1.id;
                    } else if (score2 > score1) {
                        match.winner = match.player2.id;
                    }
                }
            } else {
                match.winner = null;
            }

            // 화면 업데이트
            renderGroupContent();
            
            // 데이터 저장
            saveLeagueDataToStorage();
        }

        // 경기 결과 편집
        function editMatchResult(matchIndex) {
            const groupData = state.leagueResults[state.currentGroupIndex];
            if (!groupData || !groupData.matches[matchIndex]) return;

            const match = groupData.matches[matchIndex];
            const newScore = prompt(`${match.player1.name} vs ${match.player2.name}\n\n경기 결과를 입력하세요 (예: 3-1):`, match.score);
            
            if (newScore !== null) {
                updateMatchResult(matchIndex, newScore);
            }
        }


        // 조편성 이벤트 초기화
        function initGroupEvents() {
            if (elements.createGroupsBtn) {
                elements.createGroupsBtn.addEventListener('click', createGroups);
            }
            
            // 조 선택 모달 이벤트 초기화
            initGroupSelectModalEvents();
            
            // 토너먼트 배정 모달 이벤트 초기화
            initTournamentAssignModalEvents();
        }

        // 리그전 이벤트 초기화
        function initLeagueEvents() {
            if (elements.gameFormat) {
                elements.gameFormat.addEventListener('change', (e) => {
                    state.gameFormat = e.target.value;
                    saveLeagueDataToStorage();
                });
            }
        }

        // 리그전 데이터 저장
        function saveLeagueData() {
            try {
                saveLeagueDataToStorage();
                
                // 파일명 입력 받기
                const defaultName = `league_${new Date().toISOString().split('T')[0]}`;
                const fileName = prompt('저장할 파일명을 입력하세요:', defaultName);
                
                if (fileName === null) return; // 취소된 경우
                
                if (!fileName.trim()) {
                    showToast('파일명을 입력해주세요.', 'error');
                    return;
                }
                
                const data = JSON.stringify({
                    leagueResults: state.leagueResults,
                    gameFormat: state.gameFormat,
                    groups: state.groups
                }, null, 2);
                
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName.endsWith('.json') ? fileName : `${fileName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('리그전 데이터가 저장되었습니다.');
            } catch (e) {
                showToast('저장 중 오류가 발생했습니다.', 'error');
            }
        }

        // 리그전 데이터 파일에서 불러오기
        function loadLeagueDataFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.leagueResults) {
                            state.leagueResults = data.leagueResults;
                        }
                        if (data.gameFormat) {
                            state.gameFormat = data.gameFormat;
                            elements.gameFormat.value = data.gameFormat;
                        }
                        if (data.groups) {
                            state.groups = data.groups;
                            saveGroupsToStorage();
                        }
                        
                        // 화면 업데이트
                        renderLeagueTab();
                        saveLeagueDataToStorage();
                        showToast('리그전 데이터가 불러와졌습니다.');
                    } catch (e) {
                        showToast('파일을 읽을 수 없습니다.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 리그전 데이터 localStorage 저장
        function saveLeagueDataToStorage() {
            try {
                localStorage.setItem('league_data', JSON.stringify({
                    leagueResults: state.leagueResults,
                    gameFormat: state.gameFormat
                }));
            } catch (e) {
                console.error('리그전 데이터 저장 실패:', e);
            }
        }

        // 리그전 데이터 localStorage 로드
        function loadLeagueDataFromStorage() {
            try {
                const data = localStorage.getItem('league_data');
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.leagueResults) {
                        state.leagueResults = parsed.leagueResults;
                    }
                    if (parsed.gameFormat) {
                        state.gameFormat = parsed.gameFormat;
                        if (elements.gameFormat) {
                            elements.gameFormat.value = parsed.gameFormat;
                        }
                    }
                }
            } catch (e) {
                console.error('리그전 데이터 로드 실패:', e);
            }
        }

        // 앱 초기화
        function init() {
            try {
                initElements();
                loadFromStorage();
                loadGroupsFromStorage();
                loadLeagueDataFromStorage();
                initEvents();
                
                // 초기 포커스
                setTimeout(() => elements.nameInput.focus(), 100);
                
                console.log('앱 초기화 완료');
            } catch (e) {
                console.error('초기화 실패:', e);
            }
        }

        // 조편성 기능들
        function createGroups() {
            const groupCount = parseInt(elements.groupCount.value);
            
            if (state.players.length === 0) {
                showToast('등록된 선수가 없습니다.', 'error');
                return;
            }
            
            state.groups = [];
            for (let i = 0; i < groupCount; i++) {
                state.groups.push({ players: [] });
            }
            
            renderGroups();
            renderUnassignedPlayers();
            saveGroupsToStorage();
            showToast(`${groupCount}개 조가 생성되었습니다.`);
        }

        function renderGroups() {
            const container = elements.groupsContainer;
            
            if (state.players.length === 0) {
                container.innerHTML = `
                    <div class="drop-zone" style="grid-column: 1 / -1;">
                        <i class="fas fa-user-plus" style="font-size: 24px; margin-bottom: 8px; display: block; color: var(--text-light);"></i>
                        <p style="margin: 0; color: var(--text-light);">먼저 선수등록 탭에서 선수를 등록해주세요</p>
                    </div>
                `;
            } else if (state.groups.length === 0) {
                container.innerHTML = `
                    <div class="drop-zone" style="grid-column: 1 / -1;">
                        <i class="fas fa-layer-group" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                        <p style="margin: 0;">조 개수를 설정하고 '조 생성' 버튼을 클릭하세요</p>
                    </div>
                `;
            } else {
                container.innerHTML = state.groups.map((group, index) => `
                    <div class="group-card" data-group="${index}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="font-size: 16px; font-weight: 600; color: var(--text); margin: 0;">
                                ${index + 1}조 (${group.players.length}명)
                            </h4>
                            <button onclick="removeGroup(${index})" style="color: #dc2626; background: none; border: none; cursor: pointer; padding: 4px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="drop-zone" data-group="${index}">
                            ${group.players.length === 0 ? 
                                '<p style="margin: 0; color: var(--text-light); text-align: center; padding: 20px;">빈 조</p>' :
                                group.players.map(player => `
                                    <div class="player-item" data-player="${player.id}" onclick="selectPlayerForGroup('${player.id}')">
                                        <div>
                                            <span style="font-weight: 500; font-size: 14px;">${player.name}</span>
                                            <br>
                                            <span class="badge" style="font-size: 11px;">${player.level}</span>
                                        </div>
                                        <i class="fas fa-chevron-right" style="color: var(--text-light); font-size: 12px;"></i>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `).join('');
                
                // 조편성이 완료되면 자동으로 리그전 데이터 생성
                if (isGroupingCompleted()) {
                    generateLeagueData();
                    showToast('조편성이 완료되었습니다! 리그전 탭에서 경기를 진행하세요.', 'success');
                }
            }
        }

        function renderUnassignedPlayers() {
            const container = elements.unassignedPlayers;
            const unassignedPlayers = getUnassignedPlayers();
            
            elements.unassignedCount.textContent = unassignedPlayers.length;
            
            if (state.players.length === 0) {
                container.innerHTML = '<p style="margin: 0; color: var(--text-light); text-align: center; padding: 20px;">먼저 선수등록 탭에서 선수를 등록해주세요</p>';
            } else if (state.groups.length === 0) {
                // 조가 없어도 등록된 선수는 표시 (클릭 불가능)
                container.innerHTML = state.players.map(player => `
                    <div class="player-item" style="opacity: 0.6; cursor: not-allowed;" title="조를 먼저 생성해주세요">
                        <div>
                            <span style="font-weight: 500; font-size: 16px;">${player.name}</span>
                            <br>
                            <span class="badge" style="font-size: 12px;">${player.level}</span>
                        </div>
                        <i class="fas fa-lock" style="color: var(--text-light); font-size: 14px;"></i>
                    </div>
                `).join('');
            } else if (unassignedPlayers.length === 0) {
                container.innerHTML = '<p style="margin: 0; color: var(--text-light); text-align: center; padding: 20px;">모든 선수가 편성되었습니다!</p>';
            } else {
                container.innerHTML = unassignedPlayers.map(player => `
                    <div class="player-item" data-player="${player.id}" onclick="selectPlayerForGroup('${player.id}')">
                        <div>
                            <span style="font-weight: 500; font-size: 16px;">${player.name}</span>
                            <br>
                            <span class="badge" style="font-size: 12px;">${player.level}</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-light); font-size: 14px;"></i>
                    </div>
                `).join('');
            }
        }

        function getUnassignedPlayers() {
            const assignedPlayerIds = new Set();
            state.groups.forEach(group => {
                group.players.forEach(player => {
                    assignedPlayerIds.add(player.id);
                });
            });
            
            return state.players.filter(player => !assignedPlayerIds.has(player.id));
        }

        let selectedPlayerId = null;

        function selectPlayerForGroup(playerId) {
            if (state.groups.length === 0) {
                showToast('먼저 조를 생성해주세요.', 'error');
                return;
            }
            
            selectedPlayerId = playerId;
            const player = state.players.find(p => p.id == playerId);
            
            if (!player) return;
            
            // 조 선택 모달 표시
            showGroupSelectModal(player);
        }

        function showGroupSelectModal(player) {
            elements.selectedPlayerName.textContent = player.name;
            
            // 조 선택 카드들 생성
            const groupCards = state.groups.map((group, index) => {
                const currentGroupIndex = group.players.findIndex(p => p.id == player.id);
                const isCurrentGroup = currentGroupIndex !== -1;
                
                return `
                    <div class="group-option ${isCurrentGroup ? 'selected' : ''}" onclick="assignPlayerToGroup(${index})" data-group="${index}">
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            ${index + 1}조
                        </div>
                        <div style="font-size: 14px; color: var(--text-light); margin-bottom: 12px;">
                            ${group.players.length}명
                        </div>
                        <div style="font-size: 12px; color: var(--text-light);">
                            ${group.players.length === 0 ? '빈 조' : 
                              group.players.slice(0, 3).map(p => p.name).join(', ') + 
                              (group.players.length > 3 ? '...' : '')}
                        </div>
                        ${isCurrentGroup ? '<div style="margin-top: 8px; font-size: 12px; color: var(--green); font-weight: 500;">현재 위치</div>' : ''}
                    </div>
                `;
            }).join('');
            
            elements.groupSelectContainer.innerHTML = groupCards;
            elements.groupSelectModal.style.display = 'flex';
        }

        function closeGroupSelectModal() {
            elements.groupSelectModal.style.display = 'none';
            selectedPlayerId = null;
        }

        // 모달 외부 클릭 시 닫기
        function initGroupSelectModalEvents() {
            if (elements.groupSelectModal) {
                elements.groupSelectModal.addEventListener('click', (e) => {
                    if (e.target === elements.groupSelectModal) {
                        closeGroupSelectModal();
                    }
                });
            }
            
            // ESC 키로 모달 닫기
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && elements.groupSelectModal.style.display === 'flex') {
                    closeGroupSelectModal();
                }
            });
        }

        // 토너먼트 배정 모달 이벤트 초기화
        function initTournamentAssignModalEvents() {
            if (elements.tournamentAssignModal) {
                elements.tournamentAssignModal.addEventListener('click', (e) => {
                    if (e.target === elements.tournamentAssignModal) {
                        closeTournamentAssignModal();
                    }
                });
            }
            
            // ESC 키로 모달 닫기
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && elements.tournamentAssignModal.style.display === 'flex') {
                    closeTournamentAssignModal();
                }
            });

            // 배정 확인 버튼 이벤트
            if (elements.confirmTournamentAssign) {
                elements.confirmTournamentAssign.addEventListener('click', confirmTournamentAssignment);
            }

            // 배정 삭제 버튼 이벤트
            if (elements.deleteTournamentAssign) {
                elements.deleteTournamentAssign.addEventListener('click', deleteTournamentAssignment);
            }
        }

        function assignPlayerToGroup(targetGroupIndex) {
            if (!selectedPlayerId) return;
            
            const player = state.players.find(p => p.id == selectedPlayerId);
            if (!player) return;
            
            // 기존 조에서 선수 제거
            state.groups.forEach(group => {
                const index = group.players.findIndex(p => p.id == selectedPlayerId);
                if (index !== -1) {
                    group.players.splice(index, 1);
                }
            });
            
            // 새 조에 선수 추가
            state.groups[targetGroupIndex].players.push(player);
            
            renderGroups();
            renderUnassignedPlayers();
            saveGroupsToStorage();
            
            // 모달 닫기
            closeGroupSelectModal();
            
            showToast(`${player.name} 선수가 ${targetGroupIndex + 1}조로 이동되었습니다.`);
        }

        function removeGroup(index) {
            if (!confirm('이 조를 삭제하시겠습니까?')) return;
            
            state.groups.splice(index, 1);
            renderGroups();
            renderUnassignedPlayers();
            saveGroupsToStorage();
            showToast('조가 삭제되었습니다.');
        }


        // 리그전 데이터 생성
        function generateLeagueData() {
            state.leagueResults = {};
            
            state.groups.forEach((group, groupIndex) => {
                if (group.players && group.players.length > 0) {
                    const players = group.players;
                    const matches = [];
                    
                    // 모든 선수 간의 경기 생성 (랜덤 순서)
                    for (let i = 0; i < players.length; i++) {
                        for (let j = i + 1; j < players.length; j++) {
                            matches.push({
                                player1: players[i],
                                player2: players[j],
                                score: '-',
                                winner: null
                            });
                        }
                    }
                    
                    // 경기 순서 랜덤화
                    for (let i = matches.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [matches[i], matches[j]] = [matches[j], matches[i]];
                    }
                    
                    state.leagueResults[groupIndex] = {
                        matches: matches,
                        players: players
                    };
                }
            });
            
            // 리그전 데이터 저장
            saveLeagueDataToStorage();
        }


        function saveGroupsToStorage() {
            try {
                localStorage.setItem('tournament_groups', JSON.stringify(state.groups));
            } catch (e) {
                console.error('조편성 데이터 저장 실패:', e);
            }
        }

        function loadGroupsFromStorage() {
            try {
                const data = localStorage.getItem('tournament_groups');
                if (data) {
                    state.groups = JSON.parse(data);
                }
            } catch (e) {
                console.error('조편성 데이터 로드 실패:', e);
            }
        }


        // 전역 함수
        window.deletePlayer = deletePlayer;
        window.editPlayer = editPlayer;
        window.editName = editName;
        window.editLevel = editLevel;
        window.switchTab = switchTab;
        window.createGroups = createGroups;
        window.selectPlayerForGroup = selectPlayerForGroup;
        window.assignPlayerToGroup = assignPlayerToGroup;
        window.removeGroup = removeGroup;
        window.closeGroupSelectModal = closeGroupSelectModal;
        window.switchToGroup = switchToGroup;
        window.updateMatchResult = updateMatchResult;
        window.updateMatchScore = updateMatchScore;
        window.editMatchResult = editMatchResult;
        window.saveLeagueData = saveLeagueData;
        window.loadLeagueData = loadLeagueDataFromFile;
        window.showPlayerMatchInfo = showPlayerMatchInfo;
        window.selectMatchWinner = selectMatchWinner;
        window.confirmMatchWinner = confirmMatchWinner;
        window.closeMatchInfoModal = closeMatchInfoModal;
        window.closeTournamentAssignModal = closeTournamentAssignModal;
        window.confirmTournamentAssignment = confirmTournamentAssignment;
        window.deleteTournamentAssignment = deleteTournamentAssignment;
        window.deleteSingleTournamentAssignment = deleteSingleTournamentAssignment;
        window.clearAllTournamentAssignments = clearAllTournamentAssignments;
        window.refreshTournamentDisplay = refreshTournamentDisplay;
        window.openMobileSimpleAssignModal = openMobileSimpleAssignModal;
        window.closeMobileSimpleAssignModal = closeMobileSimpleAssignModal;
        window.showTournamentPlayerRegisterModal = showTournamentPlayerRegisterModal;
        window.selectPlayerForTournament = selectPlayerForTournament;
        window.clearTournamentSlot = clearTournamentSlot;
        window.closeTournamentPlayerRegisterModal = closeTournamentPlayerRegisterModal;

        // 토너먼트 관련 기능
        function initTournamentTab() {
            createTournamentPlayers();
            drawTournamentBracket();
            updateTournamentDisplay(); // 배정된 선수 표시
            
            // 모바일에서 스크롤 힌트 표시
            const scrollHint = document.querySelector('.mobile-scroll-hint');
            if (scrollHint && window.innerWidth <= 768) {
                scrollHint.style.display = 'inline';
                
                // 3초 후 힌트 숨기기
                setTimeout(() => {
                    if (scrollHint) {
                        scrollHint.style.opacity = '0.5';
                    }
                }, 3000);
            }
        }

        function createTournamentPlayers() {
            const playersEl = document.getElementById('tournamentPlayers');
            if (!playersEl) return;
            
            // 기존 선수 박스 제거
            playersEl.innerHTML = '';
            
            // 선수 박스 A~AF 생성 (32개)
            const labels = [];
            for (let i = 0; i < 26; i++) {
                labels.push(String.fromCharCode(65 + i)); // A-Z
            }
            for (let i = 0; i < 6; i++) {
                labels.push('A' + String.fromCharCode(65 + i)); // AA-AF
            }
            
            labels.forEach(lbl => {
                const d = document.createElement('div');
                d.className = 'tournament-player';
                d.textContent = lbl;
                d.dataset.label = lbl;
                d.style.cursor = 'pointer';
                d.addEventListener('click', function() {
                    // 토너먼트가 시작되지 않았으면 선수 등록 모달 표시
                    if (!tournamentState.isStarted) {
                        showTournamentPlayerRegisterModal(lbl);
                    } else {
                        // 토너먼트가 시작되었으면 기존 경기 정보 표시
                        showPlayerMatchInfo(lbl);
                    }
                });
                playersEl.appendChild(d);
            });
        }

        function drawTournamentBracket() {
            const svg = document.getElementById('tournamentSvg');
            if (!svg) return;
            
            // 기존 SVG 내용 제거
            while(svg.firstChild) svg.removeChild(svg.firstChild);
            
            const board = document.getElementById('tournamentBoard');
            const qbox = document.getElementById('qbox');
            const playerBoxes = Array.from(document.querySelectorAll('.tournament-player'));
            
            if (!board || !qbox || playerBoxes.length === 0) return;
            
            const rects = playerBoxes.map(el => el.getBoundingClientRect());
            const boardRect = board.getBoundingClientRect();

            // 선수 박스의 중심점 계산 (보드 기준)
            const centers = rects.map(r => ({
                x: r.left - boardRect.left + r.width/2, 
                y: r.top - boardRect.top + r.height/2
            }));

            // Q 박스를 16번째와 17번째 선수 사이에 배치 (인덱스 15와 16)
            if(centers[15] && centers[16]){
                const qTop = (centers[15].y + centers[16].y)/2 - 24; // 위쪽으로 오프셋
                qbox.style.top = qTop + 'px';
            }

            // SVG 요소 생성 헬퍼 함수
            const svgns = 'http://www.w3.org/2000/svg';
            function createLine(x1, y1, x2, y2, isEmptySlot = false) {
                const p = document.createElementNS(svgns, 'path');
                p.setAttribute('d', `M ${x1} ${y1} L ${x2} ${y2}`);
                
                if (isEmptySlot) {
                    p.setAttribute('stroke', '#9E9E9E');
                    p.setAttribute('stroke-width', '1.5');
                    p.setAttribute('stroke-dasharray', '3,3');
                    p.setAttribute('class', 'empty-slot-line');
                } else {
                    p.setAttribute('stroke', '#cfdff4');
                    p.setAttribute('stroke-width', '1.6');
                }
                
                p.setAttribute('fill', 'none');
                svg.appendChild(p);
            }

            function createText(x, y, text, isEmptySlot = false) {
                const t = document.createElementNS(svgns, 'text');
                t.setAttribute('x', x);
                t.setAttribute('y', y);
                t.setAttribute('text-anchor', 'middle');
                
                if (isEmptySlot) {
                    t.setAttribute('font-size', '10');
                    t.setAttribute('fill', '#9E9E9E');
                    t.setAttribute('class', 'empty-slot-text');
                } else {
                    t.setAttribute('font-size', '12');
                    t.setAttribute('fill', '#FF9800');
                }
                
                t.setAttribute('font-weight', 'bold');
                t.textContent = text;
                svg.appendChild(t);
            }

            // 승자 이름을 초록 배경, 흰색 글씨 배지로 표시
            function createGreenWinnerBadge(x, y, text) {
                // 텍스트 먼저 추가해 bbox 측정
                const t = document.createElementNS(svgns, 'text');
                t.setAttribute('x', x);
                t.setAttribute('y', y);
                t.setAttribute('text-anchor', 'middle');
                t.setAttribute('font-size', '11');
                t.setAttribute('fill', '#ffffff');
                t.setAttribute('font-weight', 'bold');
                t.textContent = text;
                svg.appendChild(t);

                // 텍스트 크기 측정 후 배경 렉트 추가
                const bbox = t.getBBox();
                const paddingX = 8;
                const paddingY = 4;
                const r = document.createElementNS(svgns, 'rect');
                r.setAttribute('x', (bbox.x - paddingX).toString());
                r.setAttribute('y', (bbox.y - paddingY).toString());
                r.setAttribute('width', (bbox.width + paddingX * 2).toString());
                r.setAttribute('height', (bbox.height + paddingY * 2).toString());
                r.setAttribute('rx', '6');
                r.setAttribute('ry', '6');
                r.setAttribute('fill', '#4CAF50');
                r.setAttribute('stroke', '#388E3C');
                r.setAttribute('stroke-width', '1');
                
                // 텍스트 뒤로 배경 배치
                svg.insertBefore(r, t);
            }


            // 32강 대진표 방식으로 라운드별 대진표 그리기
            let current = centers.slice();
                const levels = [];
                
            // 각 라운드별로 연결선 그리기
            for(let round = 0; round < 5; round++){
                    const next = [];
                const roundNumber = round + 1;
                const roundMatches = bracketMatches[roundNumber];
                
                if (roundMatches) {
                    // 대진표 매치에 따라 그리기
                    for (let matchIndex = 0; matchIndex < roundMatches.length; matchIndex++) {
                        const matchPair = roundMatches[matchIndex];
                        const [slotA, slotB] = matchPair;
                        
                        // 슬롯 인덱스 찾기
                        const slotAIndex = playerBoxes.findIndex(box => box.dataset.label === slotA);
                        const slotBIndex = playerBoxes.findIndex(box => box.dataset.label === slotB);
                        
                        if (slotAIndex === -1 || slotBIndex === -1) continue;
                        
                        let a, b;
                        
                        if (round === 0) {
                            // 1라운드는 선수 박스 위치 사용
                            a = current[slotAIndex];
                            b = current[slotBIndex];
                        } else {
                            // 2라운드 이후는 이전 라운드의 승자 위치 사용
                            const prevLevel = levels[round - 1];
                            if (prevLevel && prevLevel.length > 0) {
                                // 이전 라운드에서 해당 슬롯의 승자가 있는 위치 찾기
                                const prevMatchIndex = Math.floor(matchIndex * 2);
                                a = prevLevel[prevMatchIndex] || current[slotAIndex];
                                b = prevLevel[prevMatchIndex + 1] || current[slotBIndex];
                            } else {
                                a = current[slotAIndex];
                                b = current[slotBIndex];
                            }
                        }
                        
                        if (!a || !b) continue;
                        
                        // 해당 슬롯에 선수가 등록되어 있는지 확인
                        const hasPlayerA = slotA && tournamentAssignments[slotA];
                        const hasPlayerB = slotB && tournamentAssignments[slotB];
                        
                        // 부전승 선수인지 확인
                        const isByeA = hasPlayerA && tournamentState.winners[slotA] && 
                            tournamentState.matches.some(match => 
                                match.isBye && match.player1.slot === slotA
                            );
                        const isByeB = hasPlayerB && tournamentState.winners[slotB] && 
                            tournamentState.matches.some(match => 
                                match.isBye && match.player1.slot === slotB
                            );
                        
                        // 부모 포인트는 자식들 위에 점진적으로 배치
                        const px = (a.x + b.x) / 2;
                        const py = Math.min(a.y, b.y) - (60 + round * 40);
                        
                        // 각 자식에서 위로 올라가는 세로선 그리기
                        // 선수가 없는 경우 점선으로 표시
                        createLine(a.x, a.y, a.x, py, !hasPlayerA);
                        createLine(b.x, b.y, b.x, py, !hasPlayerB);
                        
                        // 두 세로선 사이 연결
                        // 둘 다 선수가 없으면 점선으로 표시
                        createLine(a.x, py, b.x, py, !hasPlayerA && !hasPlayerB);
                        
                        // 라운드 텍스트 표시 (선수가 있는 경우에만)
                        if (hasPlayerA || hasPlayerB) {
                            const roundText = round === 0 ? '32강' : round === 1 ? '16강' : round === 2 ? '8강' : round === 3 ? '4강' : '결승';
                            createText(px, py - 10, roundText, false);
                        }
                        
                        // 부전승 표시 (부전승 선수가 있는 경우)
                        if (isByeA || isByeB) {
                            const byeText = '부전승';
                            createText(px, py + 15, byeText, false);
                        }
                        
                        // 승자 이름 표시 (라운드 텍스트 바로 아래, 초록 배지)
                        const winnersOfThisRound = tournamentState.roundWinners[roundNumber] || [];
                        const matchWinner = winnersOfThisRound.find(w => w.slot === slotA || w.slot === slotB);
                        if (matchWinner && matchWinner.name) {
                            // 라운드 텍스트(py - 10) 아래 공간에 배치
                            createGreenWinnerBadge(px, py + 4, matchWinner.name);
                        }
                        
                        // 다음 라운드를 위한 포인트 저장
                        next.push({x: px, y: py});
                    }
                } else {
                    // 기존 방식으로 그리기 (fallback)
                    for(let i = 0; i < current.length; i += 2){
                        const a = current[i];
                        const b = current[i + 1];
                        if(!a || !b) continue;
                        
                        const px = (a.x + b.x) / 2;
                        const py = Math.min(a.y, b.y) - (60 + round * 40);
                        
                        createLine(a.x, a.y, a.x, py, false);
                        createLine(b.x, b.y, b.x, py, false);
                        createLine(a.x, py, b.x, py, false);
                        
                        const roundText = round === 0 ? '32강' : round === 1 ? '16강' : round === 2 ? '8강' : round === 3 ? '4강' : '결승';
                        createText(px, py - 10, roundText, false);
                        
                        next.push({x: px, y: py});
                    }
                    }
                    
                    levels.push(next);
                    current = next;
                }
                
            // 트로피까지의 최종 선 그리기
            if(current[0]){
                const trophyX = boardRect.width / 2;
                const trophyY = 28 + 18; // 상단 근처
                // 준결승에서 트로피까지 세로선
                createLine(current[0].x, current[0].y, current[0].x, trophyY + 6);
                createLine(current[0].x, trophyY + 6, trophyX, trophyY + 6);
            }

            // 모바일에서 대진표가 잘 보이도록 스크롤 위치 조정
            if (window.innerWidth <= 768) {
                const scrollContainer = document.querySelector('.tournament-scroll-container');
                if (scrollContainer) {
                    // 대진표의 중앙으로 스크롤
                    const scrollLeft = (board.scrollWidth - scrollContainer.clientWidth) / 2;
                    scrollContainer.scrollLeft = Math.max(0, scrollLeft);
                }
            }
        }

        // 토너먼트 탭 전환 시 초기화
        function initTournamentTabOnSwitch() {
            if (state.currentTab === 'tournament') {
                initTournamentTab();
            }
        }

        // 윈도우 리사이즈 시 토너먼트 대진표 다시 그리기
        function handleTournamentResize() {
            if (state.currentTab === 'tournament') {
                setTimeout(() => {
                    drawTournamentBracket();
                }, 100);
            }
        }

        // 토너먼트 설정 관련 기능
        let selectedPlayer = null;
        let tournamentAssignments = {};
        let selectedSlot = null;
        
        // 경기 정보 모달 관련 변수
        let currentMatchInfo = null;
        let selectedWinner = null;

        // 대진표 매치 관계 정의 (32강 토너먼트)
        const bracketMatches = {
            1: [ // 1라운드 (32강)
                ['A', 'B'], ['C', 'D'], ['E', 'F'], ['G', 'H'],
                ['I', 'J'], ['K', 'L'], ['M', 'N'], ['O', 'P'],
                ['Q', 'R'], ['S', 'T'], ['U', 'V'], ['W', 'X'],
                ['Y', 'Z'], ['AA', 'AB'], ['AC', 'AD'], ['AE', 'AF']
            ],
            2: [ // 2라운드 (16강)
                ['A', 'C'], ['E', 'G'], ['I', 'K'], ['M', 'O'],
                ['Q', 'S'], ['U', 'W'], ['Y', 'AA'], ['AC', 'AE']
            ],
            3: [ // 3라운드 (8강)
                ['A', 'E'], ['I', 'M'], ['Q', 'U'], ['Y', 'AC']
            ],
            4: [ // 4라운드 (4강)
                ['A', 'I'], ['Q', 'Y']
            ],
            5: [ // 5라운드 (결승)
                ['A', 'Q']
            ]
        };

// 토너먼트 설정 탭 제거됨

        function renderGroupPlayersList() {
            const container = document.getElementById('groupPlayersList');
            if (!container) return;

            if (!state.groups || state.groups.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">먼저 조편성을 완료해주세요</p>';
                return;
            }

            container.innerHTML = '';
            state.groups.forEach((group, groupIndex) => {
                const groupCard = document.createElement('div');
                groupCard.className = 'group-card-settings';
                groupCard.innerHTML = `
                    <div class="group-title-settings">${group.name}</div>
                    <div class="group-players-list">
                        ${group.players.map(player => `
                            <div class="player-item-settings" data-player-id="${player.id}" data-player-name="${player.name}" data-player-level="${player.level}">
                                <span>${player.name}</span>
                                <span class="player-level">${player.level}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(groupCard);
            });

            // 선수 클릭 이벤트 추가 (모바일 터치 지원)
            container.querySelectorAll('.player-item-settings').forEach(item => {
                item.addEventListener('click', selectPlayer);
                item.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    selectPlayer(e);
                }, { passive: false });
            });
        }

        function renderTournamentSlots() {
            const container = document.getElementById('tournamentSlots');
            if (!container) return;

            // A~AF 라벨 생성 (32개)
            const labels = [];
            for (let i = 0; i < 26; i++) {
                labels.push(String.fromCharCode(65 + i)); // A-Z
            }
            for (let i = 0; i < 6; i++) {
                labels.push('A' + String.fromCharCode(65 + i)); // AA-AF
            }
            
            container.innerHTML = '';
            
            labels.forEach(label => {
                const slot = document.createElement('div');
                slot.className = 'tournament-slot';
                slot.dataset.slot = label;
                slot.style.opacity = '0.6';
                slot.style.cursor = 'default';
                slot.innerHTML = `
                    <div class="slot-label">${label}</div>
                    <div class="slot-player"></div>
                `;
                slot.addEventListener('click', assignPlayerToSlot);
                slot.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    assignPlayerToSlot(e);
                }, { passive: false });
                container.appendChild(slot);
            });
        }

        function selectPlayer(event) {
            // 기존 선택 해제
            document.querySelectorAll('.player-item-settings').forEach(item => {
                item.classList.remove('selected');
            });

            // 새 선택
            const playerItem = event.currentTarget;
            playerItem.classList.add('selected');
            selectedPlayer = {
                id: playerItem.dataset.playerId,
                name: playerItem.dataset.playerName,
                level: playerItem.dataset.playerLevel
            };

            // 모바일에서는 간단한 모달 열기
            if (window.innerWidth <= 768) {
                openMobileSimpleAssignModal();
            } else {
                // 데스크톱에서는 기존 방식
                activateTournamentSlots();
                document.getElementById('tournamentSlots').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        function activateTournamentSlots() {
            // 모든 토너먼트 슬롯에 활성화 클래스 추가
            document.querySelectorAll('.tournament-slot').forEach(slot => {
                slot.classList.add('selectable');
                slot.style.cursor = 'pointer';
                slot.style.opacity = '1';
            });
            
            // 선택된 선수 정보 표시
            const selectedPlayerInfo = document.createElement('div');
            selectedPlayerInfo.id = 'selectedPlayerInfo';
            selectedPlayerInfo.style.cssText = `
                background: var(--green-light);
                border: 2px solid var(--green);
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 16px;
                text-align: center;
                font-weight: 500;
                color: var(--green);
            `;
            selectedPlayerInfo.innerHTML = `
                <i class="fas fa-user" style="margin-right: 8px;"></i>
                ${selectedPlayer.name} (${selectedPlayer.level}) - 배정할 위치를 선택하세요
            `;
            
            // 기존 선택 정보 제거
            const existingInfo = document.getElementById('selectedPlayerInfo');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // 토너먼트 배정 영역 상단에 선택 정보 추가
            const tournamentSlots = document.getElementById('tournamentSlots');
            tournamentSlots.parentNode.insertBefore(selectedPlayerInfo, tournamentSlots);
        }

        function deactivateTournamentSlots() {
            // 모든 토너먼트 슬롯에서 활성화 클래스 제거
            document.querySelectorAll('.tournament-slot').forEach(slot => {
                slot.classList.remove('selectable');
                slot.style.cursor = 'default';
                slot.style.opacity = '0.6';
            });
            
            // 선택된 선수 정보 제거
            const selectedPlayerInfo = document.getElementById('selectedPlayerInfo');
            if (selectedPlayerInfo) {
                selectedPlayerInfo.remove();
            }
            
            // 모바일 안내 제거
            hideMobileAssignmentGuide();
        }

        function showMobileAssignmentGuide() {
            // 기존 안내 제거
            hideMobileAssignmentGuide();
            
            const guide = document.createElement('div');
            guide.id = 'mobileAssignmentGuide';
            guide.style.cssText = `
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                background: var(--green);
                color: white;
                padding: 12px 16px;
                text-align: center;
                font-size: 16px;
                font-weight: 500;
                z-index: 1001;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                animation: slideDown 0.3s ease;
            `;
            guide.innerHTML = `
                <i class="fas fa-hand-pointer" style="margin-right: 8px;"></i>
                ${selectedPlayer.name} 선택됨 - 아래 배정 위치를 터치하세요
            `;
            
            document.body.appendChild(guide);
            
            // CSS 애니메이션 추가
            if (!document.getElementById('mobileGuideAnimation')) {
                const style = document.createElement('style');
                style.id = 'mobileGuideAnimation';
                style.textContent = `
                    @keyframes slideDown {
                        from { transform: translateY(-100%); }
                        to { transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function hideMobileAssignmentGuide() {
            const guide = document.getElementById('mobileAssignmentGuide');
            if (guide) {
                guide.remove();
            }
        }

        // 모바일 간단한 배정 모달 관련 함수들
        function openMobileSimpleAssignModal() {
            const modal = document.getElementById('mobileSimpleAssignModal');
            const playerName = document.getElementById('mobileSimplePlayerName');
            
            // 선수 정보 업데이트
            playerName.textContent = selectedPlayer.name;
            
            // 슬롯 그리드 렌더링
            renderMobileSimpleSlotGrid();
            
            // 모달 표시
            modal.style.display = 'flex';
        }

        function closeMobileSimpleAssignModal() {
            const modal = document.getElementById('mobileSimpleAssignModal');
            modal.style.display = 'none';
            
            // 선택 해제
            clearSelection();
        }

        function renderMobileSimpleSlotGrid() {
            const container = document.getElementById('mobileSimpleSlotGrid');
            if (!container) return;

            const labels = 'A B C D E F G H I J K L M N O P'.split(' ');
            container.innerHTML = '';
            
            labels.forEach(label => {
                const slot = document.createElement('div');
                slot.className = 'mobile-simple-slot';
                slot.dataset.slot = label;
                slot.style.cssText = `
                    background: white;
                    border: 2px solid var(--border);
                    border-radius: 12px;
                    padding: 16px 8px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    min-height: 60px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                `;
                
                // 이미 배정된 선수가 있는지 확인
                const assignedPlayer = tournamentAssignments[label];
                if (assignedPlayer) {
                    slot.style.background = 'var(--green-light)';
                    slot.style.borderColor = 'var(--green)';
                    slot.innerHTML = `
                        <div style="font-size: 18px; font-weight: bold; color: var(--green); margin-bottom: 4px;">${label}</div>
                        <div style="font-size: 12px; color: var(--text); word-break: break-all;">${assignedPlayer.name}</div>
                    `;
                } else {
                    slot.innerHTML = `
                        <div style="font-size: 18px; font-weight: bold; color: var(--text); margin-bottom: 4px;">${label}</div>
                        <div style="font-size: 12px; color: var(--text-light);">빈 슬롯</div>
                    `;
                }
                
                // 터치 이벤트 추가
                slot.addEventListener('click', assignPlayerToMobileSlot);
                slot.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    assignPlayerToMobileSlot(e);
                }, { passive: false });
                
                container.appendChild(slot);
            });
        }

        function assignPlayerToMobileSlot(event) {
            const slot = event.currentTarget;
            const slotLabel = slot.dataset.slot;
            const assignedPlayer = tournamentAssignments[slotLabel];

            // 이미 배정된 슬롯을 클릭한 경우 배정 해제
            if (assignedPlayer && !selectedPlayer) {
                delete tournamentAssignments[slotLabel];
                showToast(`${assignedPlayer.name}의 배정이 해제되었습니다.`, 'info');
                
                // 슬롯 그리드 다시 렌더링
                renderMobileSimpleSlotGrid();
                
                // 저장 버튼 표시
                document.getElementById('saveTournamentAssignments').style.display = 'inline-block';
                return;
            }

            if (!selectedPlayer) return;

            // 이미 배정된 선수가 있는지 확인
            const existingPlayer = Object.values(tournamentAssignments).find(player => player.id === selectedPlayer.id);
            if (existingPlayer) {
                showToast('이미 배정된 선수입니다. 먼저 기존 배정을 해제하세요.', 'warning');
                return;
            }

            // 슬롯에 선수 배정
            tournamentAssignments[slotLabel] = selectedPlayer;
            
            // UI 업데이트
            updateSlotDisplay(document.querySelector(`[data-slot="${slotLabel}"]`), selectedPlayer);
            updatePlayerStatus(selectedPlayer.id, true);
            
            // 모달 닫기
            closeMobileSimpleAssignModal();
            
            // 저장 버튼 표시
            document.getElementById('saveTournamentAssignments').style.display = 'inline-block';
            
            showToast(`${selectedPlayer.name}이(가) ${slotLabel}에 배정되었습니다.`, 'success');
        }

        function assignPlayerToSlot(event) {
            if (!selectedPlayer) return;

            const slot = event.currentTarget;
            const slotLabel = slot.dataset.slot;

            // 이미 배정된 선수가 있는지 확인
            const existingPlayer = Object.values(tournamentAssignments).find(player => player.id === selectedPlayer.id);
            if (existingPlayer) {
                showToast('이미 배정된 선수입니다. 먼저 기존 배정을 해제하세요.', 'warning');
                return;
            }

            // 슬롯에 선수 배정
            tournamentAssignments[slotLabel] = selectedPlayer;
            
            // UI 업데이트
            updateSlotDisplay(slot, selectedPlayer);
            updatePlayerStatus(selectedPlayer.id, true);
            
            // 선택 해제 및 슬롯 비활성화
            clearSelection();
            deactivateTournamentSlots();
            
            // 저장 버튼 표시
            document.getElementById('saveTournamentAssignments').style.display = 'inline-block';
            
            showToast(`${selectedPlayer.name}이(가) ${slotLabel}에 배정되었습니다.`, 'success');
        }

        // 토너먼트 배정 모달 관련 함수들
        function showTournamentAssignModal(player) {
            // 모달 정보 업데이트
            document.getElementById('tournamentSelectedPlayerName').textContent = player.name;
            document.getElementById('modalPlayerName').textContent = player.name;
            document.getElementById('modalPlayerLevel').textContent = player.level;

            // 슬롯 선택 버튼들 생성
            renderTournamentSlotButtons();

            // 배정 상태 업데이트
            updateAssignedCount();

            // 모달 표시
            document.getElementById('tournamentAssignModal').style.display = 'flex';
        }

        function closeTournamentAssignModal() {
            document.getElementById('tournamentAssignModal').style.display = 'none';
            selectedSlot = null;
            document.getElementById('confirmTournamentAssign').style.display = 'none';
            document.getElementById('deleteTournamentAssign').style.display = 'none';
            document.getElementById('opponentInfo').style.display = 'none';
        }

        function renderTournamentSlotButtons() {
            const container = document.getElementById('tournamentSlotSelection');
            container.innerHTML = '';

            // A~AF 슬롯 생성 (32개)
            for (let i = 0; i < 26; i++) {
                const label = String.fromCharCode(65 + i); // A, B, C, ..., Z
                const button = document.createElement('button');
                button.className = 'tournament-slot-btn';
                button.dataset.slot = label;
                
                const isAssigned = tournamentAssignments[label];
                const opponentInfo = getOpponentInfo(label);
                
                if (isAssigned) {
                    button.classList.add('assigned');
                    button.innerHTML = `
                        <div class="slot-label">${label}</div>
                        <div class="slot-player">${isAssigned.name}</div>
                    `;
                } else {
                    // 상대방 정보 표시
                    let opponentText = '빈 슬롯';
                    let hasOpponent = false;
                    
                    if (opponentInfo && opponentInfo.player) {
                        opponentText = `vs ${opponentInfo.player.name}`;
                        hasOpponent = true;
                    } else if (opponentInfo) {
                        opponentText = `vs ${opponentInfo.slot}`;
                        hasOpponent = true;
                    }
                    
                    button.innerHTML = `
                        <div class="slot-label">${label}</div>
                        <div class="slot-player ${hasOpponent ? 'vs' : ''}">${opponentText}</div>
                    `;
                }

                button.addEventListener('click', selectTournamentSlot);
                container.appendChild(button);
            }
            
            // AA~AF 슬롯 생성 (6개)
            for (let i = 0; i < 6; i++) {
                const label = 'A' + String.fromCharCode(65 + i); // AA, AB, AC, ..., AF
                const button = document.createElement('button');
                button.className = 'tournament-slot-btn';
                button.dataset.slot = label;
                
                const isAssigned = tournamentAssignments[label];
                const opponentInfo = getOpponentInfo(label);
                
                if (isAssigned) {
                    button.classList.add('assigned');
                    button.innerHTML = `
                        <div class="slot-label">${label}</div>
                        <div class="slot-player">${isAssigned.name}</div>
                    `;
                } else {
                    // 상대방 정보 표시
                    let opponentText = '빈 슬롯';
                    let hasOpponent = false;
                    
                    if (opponentInfo && opponentInfo.player) {
                        opponentText = `vs ${opponentInfo.player.name}`;
                        hasOpponent = true;
                    } else if (opponentInfo) {
                        opponentText = `vs ${opponentInfo.slot}`;
                        hasOpponent = true;
                    }
                    
                    button.innerHTML = `
                        <div class="slot-label">${label}</div>
                        <div class="slot-player ${hasOpponent ? 'vs' : ''}">${opponentText}</div>
                    `;
                }

                button.addEventListener('click', selectTournamentSlot);
                container.appendChild(button);
            }
        }

        function selectTournamentSlot(event) {
            const button = event.currentTarget;
            const slotLabel = button.dataset.slot;
            const isAssigned = button.classList.contains('assigned');

            // 기존 선택 해제
            document.querySelectorAll('.tournament-slot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // 새 선택
            button.classList.add('selected');
            selectedSlot = slotLabel;

            // 상대방 정보 표시
            updateOpponentInfo(slotLabel);

            if (isAssigned) {
                // 이미 배정된 슬롯이면 삭제 버튼 표시
                document.getElementById('confirmTournamentAssign').style.display = 'none';
                document.getElementById('deleteTournamentAssign').style.display = 'inline-block';
            } else {
                // 빈 슬롯이면 배정 버튼 표시
                document.getElementById('confirmTournamentAssign').style.display = 'inline-block';
                document.getElementById('deleteTournamentAssign').style.display = 'none';
            }
        }

        function updateOpponentInfo(slotLabel) {
            const opponentInfo = getOpponentInfo(slotLabel);
            const opponentInfoDiv = document.getElementById('opponentInfo');
            const selectedSlotLabel = document.getElementById('selectedSlotLabel');
            const opponentName = document.getElementById('opponentName');

            selectedSlotLabel.textContent = slotLabel;

            if (opponentInfo) {
                if (opponentInfo.player) {
                    opponentName.textContent = `${opponentInfo.player.name} (${opponentInfo.slot})`;
                } else {
                    opponentName.textContent = `${opponentInfo.slot} 슬롯`;
                }
                opponentInfoDiv.style.display = 'block';
            } else {
                opponentName.textContent = '상대방 없음';
                opponentInfoDiv.style.display = 'block';
            }
        }

        // 토너먼트 배정 삭제 기능
        function deleteTournamentAssignment() {
            if (!selectedSlot) return;

            const assignedPlayer = tournamentAssignments[selectedSlot];
            if (!assignedPlayer) {
                showToast('해당 슬롯에 배정된 선수가 없습니다.', 'warning');
                return;
            }

            // 확인 메시지
            if (!confirm(`${assignedPlayer.name}의 ${selectedSlot} 슬롯 배정을 삭제하시겠습니까?`)) {
                return;
            }

            // 배정 삭제
            delete tournamentAssignments[selectedSlot];
            
            // UI 업데이트
            updateSlotDisplay(document.querySelector(`[data-slot="${selectedSlot}"]`), null);
            updatePlayerStatus(assignedPlayer.id, false);
            
            // 선택 해제
            clearSelection();
            
            // 모달 닫기
            closeTournamentAssignModal();
            
            // 슬롯 버튼 다시 렌더링
            renderTournamentSlotButtons();
            updateAssignedCount();
            
            showToast(`${assignedPlayer.name}의 배정이 삭제되었습니다.`, 'success');
        }

        function confirmTournamentAssignment() {
            if (!selectedPlayer || !selectedSlot) return;

            // 이미 배정된 선수가 있는지 확인
            const existingPlayer = Object.values(tournamentAssignments).find(player => player.id === selectedPlayer.id);
            if (existingPlayer) {
                showToast('이미 배정된 선수입니다. 먼저 기존 배정을 해제하세요.', 'warning');
                return;
            }

            // 슬롯에 선수 배정
            tournamentAssignments[selectedSlot] = selectedPlayer;
            
            // UI 업데이트
            updateSlotDisplay(document.querySelector(`[data-slot="${selectedSlot}"]`), selectedPlayer);
            updatePlayerStatus(selectedPlayer.id, true);
            
            // 선택 해제
            clearSelection();
            
            // 저장 버튼 표시
            document.getElementById('saveTournamentAssignments').style.display = 'inline-block';
            
            // 모달 닫기
            closeTournamentAssignModal();
            
            showToast(`${selectedPlayer.name}이(가) ${selectedSlot}에 배정되었습니다.`, 'success');
        }

        function updateAssignedCount() {
            const count = Object.keys(tournamentAssignments).length;
            document.getElementById('assignedCount').textContent = count;
        }

        // 상대방 정보 가져오기
        function getOpponentInfo(slot) {
            // 1라운드 매칭에서 상대방 찾기
            const round1Matches = bracketMatches[1];
            for (const match of round1Matches) {
                if (match[0] === slot) {
                    return {
                        slot: match[1],
                        player: tournamentAssignments[match[1]],
                        isFirstRound: true
                    };
                } else if (match[1] === slot) {
                    return {
                        slot: match[0],
                        player: tournamentAssignments[match[0]],
                        isFirstRound: true
                    };
                }
            }
            return null;
        }

        function updateSlotDisplay(slot, player) {
            const slotPlayer = slot.querySelector('.slot-player');
            
            if (player) {
                slotPlayer.textContent = player.name;
                slotPlayer.classList.add('assigned');
                slot.querySelector('.slot-label').classList.add('assigned');
                slot.classList.add('assigned');
            } else {
                // 삭제 시 초기화
                slotPlayer.textContent = '';
                slotPlayer.classList.remove('assigned');
                slot.querySelector('.slot-label').classList.remove('assigned');
                slot.classList.remove('assigned');
            }
        }

        function updatePlayerStatus(playerId, assigned) {
            const playerItem = document.querySelector(`[data-player-id="${playerId}"]`);
            if (playerItem) {
                if (assigned) {
                    playerItem.classList.add('assigned');
                } else {
                    playerItem.classList.remove('assigned');
                }
            }
        }

        function clearSelection() {
            selectedPlayer = null;
            selectedSlot = null;
            document.querySelectorAll('.player-item-settings').forEach(item => {
                item.classList.remove('selected');
            });
            deactivateTournamentSlots();
        }

        function clearTournamentAssignments() {
            tournamentAssignments = {};
            
            // UI 초기화
            document.querySelectorAll('.tournament-slot').forEach(slot => {
                slot.classList.remove('assigned');
                slot.querySelector('.slot-player').textContent = '';
                slot.querySelector('.slot-player').classList.remove('assigned');
                slot.querySelector('.slot-label').classList.remove('assigned');
            });
            
            document.querySelectorAll('.player-item-settings').forEach(item => {
                item.classList.remove('assigned');
            });
            
            clearSelection();
            document.getElementById('saveTournamentAssignments').style.display = 'none';
            updateAssignedCount();
            
            showToast('토너먼트 배정이 초기화되었습니다.', 'info');
        }

        function saveTournamentAssignments() {
            try {
                localStorage.setItem('tournament_assignments', JSON.stringify(tournamentAssignments));
                showToast('토너먼트 배정이 저장되었습니다.', 'success');
                
                // 토너먼트 탭 업데이트
                updateTournamentDisplay();
            } catch (e) {
                console.error('토너먼트 배정 저장 실패:', e);
                showToast('저장에 실패했습니다.', 'error');
            }
        }

        function loadTournamentAssignments() {
            try {
                const data = localStorage.getItem('tournament_assignments');
                if (data) {
                    tournamentAssignments = JSON.parse(data);
                    
                    // UI 복원
                    Object.entries(tournamentAssignments).forEach(([slot, player]) => {
                        const slotElement = document.querySelector(`[data-slot="${slot}"]`);
                        if (slotElement) {
                            updateSlotDisplay(slotElement, player);
                            updatePlayerStatus(player.id, true);
                        }
                    });
                    
                    if (Object.keys(tournamentAssignments).length > 0) {
                        document.getElementById('saveTournamentAssignments').style.display = 'inline-block';
                    }
                }
            } catch (e) {
                console.error('토너먼트 배정 로드 실패:', e);
            }
        }

        function updateTournamentDisplay() {
            // 토너먼트 탭의 선수 박스 업데이트
            const tournamentPlayers = document.querySelectorAll('.tournament-player');
            tournamentPlayers.forEach(playerBox => {
                const label = playerBox.dataset.label;
                const assignment = tournamentAssignments[label];
                
                // 기존 클래스 제거
                playerBox.classList.remove('no-match', 'bye', 'bye-advance', 'winner', 'eliminated', 'empty-slot');
                
                if (assignment) {
                    playerBox.textContent = assignment.name;
                    
                    // 패자인지 확인
                    if (tournamentState.losers.has(label)) {
                        // 패자는 회색으로 표시
                        playerBox.classList.add('eliminated');
                        playerBox.style.background = '#9E9E9E';
                        playerBox.style.color = '#666';
                        playerBox.style.border = '2px solid #757575';
                        playerBox.style.opacity = '0.7';
                        playerBox.title = '탈락';
                    }
                    // 부전승 선수인지 확인
                    else if (tournamentState.winners[label] && 
                        tournamentState.matches.some(match => 
                            match.isBye && match.player1.slot === label
                        )) {
                        // 부전승 선수는 주황색으로 표시
                        playerBox.classList.add('bye-advance');
                        playerBox.style.background = '#FF9800';
                        playerBox.style.color = 'white';
                        playerBox.style.border = '2px solid #F57C00';
                        
                        // 부전승 라운드에 따라 툴팁 텍스트 설정
                        const byeMatch = tournamentState.matches.find(match => 
                            match.isBye && match.player1.slot === label
                        );
                        if (byeMatch) {
                            const currentRound = tournamentState.currentRound;
                            const byeRound = byeMatch.round;
                            
                            if (byeRound < currentRound) {
                                // 이미 다음 라운드로 진출한 경우
                                const nextRoundName = byeRound === 1 ? '8강' : 
                                                    byeRound === 2 ? '4강' : '결승';
                                playerBox.title = `부전승으로 ${nextRoundName} 진출`;
                            } else if (byeRound === currentRound) {
                                // 현재 라운드에서 대기 중인 경우
                                const roundName = currentRound === 1 ? '16강' : 
                                                currentRound === 2 ? '8강' : 
                                                currentRound === 3 ? '4강' : '결승';
                                playerBox.title = `부전승으로 ${roundName} 대기중`;
                            } else {
                                // 아직 해당 라운드가 시작되지 않은 경우
                                playerBox.title = '부전승으로 대기중';
                            }
                        } else {
                            playerBox.title = '부전승으로 대기중';
                        }
                    } else {
                        // 일반 선수 (진행 중)
                        playerBox.style.background = '#4CAF50';
                        playerBox.style.color = 'white';
                        playerBox.style.border = '1px solid #2E7D32';
                        playerBox.style.opacity = '1';
                        playerBox.title = '진행 중';
                    }
                } else {
                    // 등록되지 않은 선수는 "경기 없음"으로 표시
                    playerBox.classList.add('no-match');
                    playerBox.textContent = label;
                    playerBox.style.background = '#f5f5f5';
                    playerBox.style.color = '#999';
                    playerBox.style.border = '2px dashed #ccc';
                    playerBox.title = '등록되지 않은 선수 - 경기 없음';
                }
            });
            
            // 대진표 다시 그리기 (빈 슬롯 반영)
            drawTournamentBracket();
            
            // 배정 관리 섹션 업데이트
            updateTournamentAssignedList();
        }

        // 토너먼트 배정 목록 업데이트
        function updateTournamentAssignedList() {
            const assignedList = document.getElementById('tournamentAssignedList');
            const assignedCount = document.getElementById('tournamentAssignedCount');
            
            if (!assignedList || !assignedCount) return;
            
            const assignments = Object.entries(tournamentAssignments);
            assignedCount.textContent = `${assignments.length}명`;
            
            if (assignments.length === 0) {
                assignedList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px; margin: 0;">배정된 선수가 없습니다.</p>';
                return;
            }
            
            assignedList.innerHTML = assignments.map(([slot, player]) => `
                <div class="assigned-player-item">
                    <div class="assigned-player-info">
                        <div class="assigned-player-slot">${slot}</div>
                        <div>
                            <div class="assigned-player-name">${player.name}</div>
                            <div class="assigned-player-level">${player.level}</div>
                        </div>
                    </div>
                    <button class="delete-assignment-btn" onclick="deleteSingleTournamentAssignment('${slot}')" title="배정 삭제">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // 개별 배정 삭제
        function deleteSingleTournamentAssignment(slot) {
            const assignedPlayer = tournamentAssignments[slot];
            if (!assignedPlayer) return;

            if (!confirm(`${assignedPlayer.name}의 ${slot} 슬롯 배정을 삭제하시겠습니까?`)) {
                return;
            }

            // 배정 삭제
            delete tournamentAssignments[slot];
            
            // UI 업데이트
            updateTournamentDisplay();
            updatePlayerStatus(assignedPlayer.id, false);
            
            showToast(`${assignedPlayer.name}의 배정이 삭제되었습니다.`, 'success');
        }

        // 전체 배정 삭제
        function clearAllTournamentAssignments() {
            const assignmentCount = Object.keys(tournamentAssignments).length;
            if (assignmentCount === 0) {
                showToast('삭제할 배정이 없습니다.', 'warning');
                return;
            }

            if (!confirm(`모든 토너먼트 배정(${assignmentCount}명)을 삭제하시겠습니까?`)) {
                return;
            }

            // 모든 배정 삭제
            tournamentAssignments = {};
            
            // UI 업데이트
            updateTournamentDisplay();
            
            // 모든 선수 상태 초기화
            document.querySelectorAll('.player-item-settings').forEach(item => {
                item.classList.remove('assigned');
            });
            
            showToast('모든 토너먼트 배정이 삭제되었습니다.', 'success');
        }

        // 토너먼트 표시 새로고침
        function refreshTournamentDisplay() {
            updateTournamentDisplay();
            showToast('토너먼트 표시가 새로고침되었습니다.', 'success');
        }

        // 토너먼트 경기 관리 기능
        let tournamentState = {
            isStarted: false,
            currentRound: 1,
            currentMatch: null,
            matches: [],
            winners: {},
            eliminated: new Set(),
            losers: new Set(), // 패자 추적
            roundWinners: {} // 라운드별 승자 추적
        };

        // 토너먼트 형식 결정
        function determineTournamentFormat(playerCount) {
            if (playerCount >= 2 && playerCount <= 4) {
                return {
                    type: 'round_robin',
                    name: '라운드 로빈',
                    description: '모든 선수가 서로 한 번씩 경기'
                };
            } else if (playerCount >= 5 && playerCount <= 8) {
                return {
                    type: 'quarter_final',
                    name: '8강 토너먼트',
                    description: '8강부터 시작하는 토너먼트'
                };
            } else if (playerCount >= 9 && playerCount <= 12) {
                return {
                    type: 'group_stage',
                    name: '조별 예선 + 4강',
                    description: '2개 조로 나누어 예선 후 4강 토너먼트'
                };
            } else if (playerCount >= 13 && playerCount <= 16) {
                return {
                    type: 'sixteen_final',
                    name: '16강 토너먼트',
                    description: '16강부터 시작하는 토너먼트 (부전승 포함)'
                };
            } else if (playerCount >= 17 && playerCount <= 32) {
                return {
                    type: 'thirty_two_final',
                    name: '32강 토너먼트',
                    description: '32강부터 시작하는 토너먼트 (부전승 포함)'
                };
            } else if (playerCount > 32) {
                return {
                    type: 'thirty_two_final',
                    name: '32강 토너먼트 (32명 제한)',
                    description: '32명까지만 참가 가능 (초과분은 제외)'
                };
            } else {
                return {
                    type: 'thirty_two_final',
                    name: '32강 토너먼트',
                    description: '32강부터 시작하는 토너먼트'
                };
            }
        }

        function startTournament() {
            const playerCount = Object.keys(tournamentAssignments).length;
            
            if (playerCount < 2) {
                showToast('최소 2명의 선수가 배정되어야 합니다.', 'warning');
                return;
            }

            if (playerCount > 32) {
                showToast('32명을 초과하는 선수가 배정되었습니다. 처음 32명만 참가합니다.', 'warning');
            }

            // 대진표 선택 모달 표시
            showBracketSelectionModal();
        }

        function showBracketSelectionModal() {
            const playerCount = Object.keys(tournamentAssignments).length;
            const options = getBracketOptions(playerCount);
            
            const modal = document.getElementById('bracketSelectModal');
            const playerCountDisplay = document.getElementById('playerCountDisplay');
            const bracketOptions = document.getElementById('bracketOptions');
            
            playerCountDisplay.textContent = playerCount;
            
            bracketOptions.innerHTML = options.map(option => `
                <div class="bracket-option ${option.recommended ? 'recommended' : ''}" 
                     onclick="selectBracketFormat('${option.type}')">
                    <div class="bracket-option-header">
                        <h4>${option.name}</h4>
                        ${option.recommended ? '<span class="recommended-badge">추천</span>' : ''}
                    </div>
                    <p>${option.description}</p>
                </div>
            `).join('');
            
            modal.style.display = 'flex';
        }

        function getBracketOptions(playerCount) {
            const options = [];
            
            // 2-4명
            if (playerCount >= 2 && playerCount <= 4) {
                options.push({
                    type: 'round_robin',
                    name: '라운드 로빈',
                    description: '모든 선수가 서로 한 번씩 경기',
                    recommended: true
                });
                options.push({
                    type: 'single_elimination_4',
                    name: '4강 토너먼트',
                    description: '4강부터 시작하는 토너먼트',
                    recommended: false
                });
            }
            
            // 5명 전용
            if (playerCount === 5) {
                options.push({
                    type: 'five_player_tournament',
                    name: '5명 토너먼트 (추천)',
                    description: '8강 토너먼트 (3명 부전승)',
                    recommended: true
                });
                options.push({
                    type: 'round_robin',
                    name: '라운드 로빈',
                    description: '모든 선수가 서로 한 번씩 경기 (10경기)',
                    recommended: false
                });
                options.push({
                    type: 'group_stage_5',
                    name: '조별 예선 + 4강',
                    description: '2개 조로 나누어 예선 후 4강',
                    recommended: false
                });
            }
            
            // 6-8명
            if (playerCount >= 6 && playerCount <= 8) {
                options.push({
                    type: 'quarter_final',
                    name: '8강 토너먼트',
                    description: '8강부터 시작하는 토너먼트',
                    recommended: true
                });
                options.push({
                    type: 'single_elimination_8',
                    name: '8강 토너먼트 (부전승)',
                    description: '8강부터 시작 (부전승 포함)',
                    recommended: false
                });
            }
            
            // 9-16명
            if (playerCount >= 9 && playerCount <= 16) {
                options.push({
                    type: 'sixteen_final',
                    name: '16강 토너먼트',
                    description: '16강부터 시작하는 토너먼트',
                    recommended: true
                });
                options.push({
                    type: 'group_stage',
                    name: '조별 예선 + 4강',
                    description: '2개 조로 나누어 예선 후 4강',
                    recommended: false
                });
            }
            
            // 17-32명
            if (playerCount >= 17 && playerCount <= 32) {
                options.push({
                    type: 'thirty_two_final',
                    name: '32강 토너먼트',
                    description: '32강부터 시작하는 토너먼트',
                    recommended: true
                });
                options.push({
                    type: 'group_stage_32',
                    name: '조별 예선 + 32강',
                    description: '4개 조로 나누어 예선 후 32강 토너먼트',
                    recommended: false
                });
            }
            
            return options;
        }

        function selectBracketFormat(formatType) {
            closeBracketSelectModal();
            
            // 5명 토너먼트인 경우 부전승 선수 선택 모달 표시
            if (formatType === 'five_player_tournament') {
                showByeSelectionModal();
                return;
            }
            
            // 토너먼트 형식 결정
            const tournamentFormat = determineTournamentFormatByType(formatType);
            
            tournamentState = {
                isStarted: true,
                currentRound: 1,
                currentMatch: null,
                matches: [],
                winners: {},
                eliminated: new Set(),
                losers: new Set(),
                roundWinners: {},
                format: tournamentFormat
            };

            // UI 업데이트
            document.getElementById('startTournament').style.display = 'none';
            document.getElementById('resetTournament').style.display = 'inline-block';
            document.getElementById('tournamentProgress').style.display = 'block';

            // 토너먼트 형식 표시
            showTournamentFormat(tournamentFormat);

            // 첫 라운드 경기 생성
            generateFirstRoundMatches();
            updateTournamentProgress();

            // 대진표 다시 그리기
            setTimeout(() => {
                drawTournamentBracket();
                updateTournamentDisplay();
            }, 200);
        }

        function determineTournamentFormatByType(formatType) {
            const playerCount = Object.keys(tournamentAssignments).length;
            
            switch (formatType) {
                case 'round_robin':
                    return {
                        type: 'round_robin',
                        name: '라운드 로빈',
                        description: '모든 선수가 서로 한 번씩 경기'
                    };
                case 'single_elimination_4':
                    return {
                        type: 'single_elimination_4',
                        name: '4강 토너먼트',
                        description: '4강부터 시작하는 토너먼트'
                    };
                case 'quarter_final':
                    return {
                        type: 'quarter_final',
                        name: '8강 토너먼트',
                        description: '8강부터 시작하는 토너먼트'
                    };
                case 'single_elimination_8':
                    return {
                        type: 'single_elimination_8',
                        name: '8강 토너먼트 (부전승)',
                        description: '8강부터 시작 (부전승 포함)'
                    };
                case 'sixteen_final':
                    return {
                        type: 'sixteen_final',
                        name: '16강 토너먼트',
                        description: '16강부터 시작하는 토너먼트'
                    };
                case 'thirty_two_final':
                    return {
                        type: 'thirty_two_final',
                        name: '32강 토너먼트',
                        description: '32강부터 시작하는 토너먼트'
                    };
                case 'group_stage':
                    return {
                        type: 'group_stage',
                        name: '조별 예선 + 4강',
                        description: '2개 조로 나누어 예선 후 4강'
                    };
                case 'group_stage_32':
                    return {
                        type: 'group_stage_32',
                        name: '조별 예선 + 32강',
                        description: '4개 조로 나누어 예선 후 32강 토너먼트'
                    };
                case 'five_player_tournament':
                    return {
                        type: 'five_player_tournament',
                        name: '5명 토너먼트',
                        description: '8강 토너먼트 (3명 부전승)'
                    };
                case 'group_stage_5':
                    return {
                        type: 'group_stage_5',
                        name: '5명 조별 예선 + 4강',
                        description: '2개 조로 나누어 예선 후 4강'
                    };
                default:
                    return determineTournamentFormat(playerCount);
            }
        }

        function closeBracketSelectModal() {
            document.getElementById('bracketSelectModal').style.display = 'none';
        }

        // 32강 토너먼트 경기 생성 (17-32명)
        function generateThirtyTwoFinalMatches(assignedPlayers) {
            // 32명 제한 적용
            const limitedPlayers = assignedPlayers.slice(0, 32);
            
            const sortedPlayers = limitedPlayers.sort((a, b) => {
                const labels = [];
                for (let i = 0; i < 26; i++) {
                    labels.push(String.fromCharCode(65 + i)); // A-Z
                }
                for (let i = 0; i < 6; i++) {
                    labels.push('A' + String.fromCharCode(65 + i)); // AA-AF
                }
                return labels.indexOf(a[0]) - labels.indexOf(b[0]);
            });
            
            // 32강으로 맞추기 위해 부전승 처리
            while (sortedPlayers.length < 32) {
                sortedPlayers.push([`BYE${sortedPlayers.length}`, { name: '부전승', slot: `BYE${sortedPlayers.length}` }]);
            }
            
            // 32강 경기 생성
            for (let i = 0; i < 32; i += 2) {
                const player1 = sortedPlayers[i];
                const player2 = sortedPlayers[i + 1];
                
                if (player1[0].startsWith('BYE') || player2[0].startsWith('BYE')) {
                    // 부전승 처리
                    const realPlayer = player1[0].startsWith('BYE') ? player2 : player1;
                    const byeMatch = {
                        round: 1,
                        player1: { slot: realPlayer[0], ...realPlayer[1] },
                        player2: null,
                        winner: { slot: realPlayer[0], ...realPlayer[1] },
                        completed: true,
                        isBye: true
                    };
                    tournamentState.matches.push(byeMatch);
                    tournamentState.winners[realPlayer[0]] = { slot: realPlayer[0], ...realPlayer[1] };
                    console.log(`32강 부전승: ${realPlayer[0]}(${realPlayer[1].name}) - 부전승으로 16강 진출`);
                } else {
                    const match = {
                        round: 1,
                        player1: { slot: player1[0], ...player1[1] },
                        player2: { slot: player2[0], ...player2[1] },
                        winner: null,
                        completed: false
                    };
                    tournamentState.matches.push(match);
                    console.log(`32강 경기: ${match.player1.slot}(${match.player1.name}) vs ${match.player2.slot}(${match.player2.name})`);
                }
            }
        }

        // 5명 토너먼트 전용 변수
        let selectedByePlayers = [];
        let remainingByePlayers = [];
        let currentMatchType = '';

        // 부전승 선수 선택 모달 표시
        function showByeSelectionModal() {
            const modal = document.getElementById('byeSelectionModal');
            const container = document.getElementById('byeSelectionContainer');
            const countDisplay = document.getElementById('byeSelectionCount');
            
            selectedByePlayers = [];
            countDisplay.textContent = '0';
            
            // 5명 선수 목록 생성
            const players = Object.entries(tournamentAssignments).slice(0, 5);
            container.innerHTML = players.map(([slot, player], index) => `
                <div class="player-selection-card" onclick="toggleByePlayer('${slot}', '${player.name}')">
                    <div class="player-info">
                        <div class="player-avatar">${slot}</div>
                        <div class="player-details">
                            <h4>${player.name}</h4>
                            <p>슬롯: ${slot}</p>
                        </div>
                    </div>
                    <div class="selection-indicator">
                        <i class="fas fa-check" style="display: none;"></i>
                    </div>
                </div>
            `).join('');
            
            modal.style.display = 'flex';
        }

        // 부전승 선수 선택/해제
        function toggleByePlayer(slot, name) {
            const card = event.currentTarget;
            const isSelected = selectedByePlayers.includes(slot);
            
            if (isSelected) {
                // 선택 해제
                selectedByePlayers = selectedByePlayers.filter(s => s !== slot);
                card.classList.remove('selected');
                card.querySelector('.selection-indicator i').style.display = 'none';
            } else {
                // 선택 (최대 3명)
                if (selectedByePlayers.length < 3) {
                    selectedByePlayers.push(slot);
                    card.classList.add('selected');
                    card.querySelector('.selection-indicator i').style.display = 'block';
                } else {
                    showToast('최대 3명까지만 선택할 수 있습니다.', 'warning');
                    return;
                }
            }
            
            // 선택 카운트 업데이트
            document.getElementById('byeSelectionCount').textContent = selectedByePlayers.length;
            
            // 확인 버튼 활성화/비활성화
            const confirmBtn = document.getElementById('confirmByeSelection');
            confirmBtn.disabled = selectedByePlayers.length !== 3;
        }

        // 부전승 선수 선택 확정
        function confirmByeSelection() {
            if (selectedByePlayers.length !== 3) {
                showToast('3명을 선택해주세요.', 'warning');
                return;
            }
            
            closeByeSelectionModal();
            
            // 5명 토너먼트 시작
            startFivePlayerTournament();
        }

        // 5명 토너먼트 시작
        function startFivePlayerTournament() {
            const tournamentFormat = {
                type: 'five_player_tournament',
                name: '5명 토너먼트',
                description: '8강 토너먼트 (3명 부전승)'
            };
            
            tournamentState = {
                isStarted: true,
                currentRound: 1,
                currentMatch: null,
                matches: [],
                winners: {},
                eliminated: new Set(),
                losers: new Set(),
                roundWinners: {},
                format: tournamentFormat,
                byePlayers: selectedByePlayers
            };

            // UI 업데이트
            document.getElementById('startTournament').style.display = 'none';
            document.getElementById('resetTournament').style.display = 'inline-block';
            document.getElementById('tournamentProgress').style.display = 'block';

            // 토너먼트 형식 표시
            showTournamentFormat(tournamentFormat);

            // 8강 경기 생성 (부전승이 아닌 2명)
            generateFivePlayerFirstRound();
            updateTournamentProgress();

            // 대진표 다시 그리기
            setTimeout(() => {
                drawTournamentBracket();
                updateTournamentDisplay();
            }, 200);
        }

        // 5명 토너먼트 8강 경기 생성
        function generateFivePlayerFirstRound() {
            const allPlayers = Object.entries(tournamentAssignments).slice(0, 5);
            const nonByePlayers = allPlayers.filter(([slot]) => !selectedByePlayers.includes(slot));
            
            if (nonByePlayers.length === 2) {
                const [slot1, player1] = nonByePlayers[0];
                const [slot2, player2] = nonByePlayers[1];
                
                const match = {
                    round: 1,
                    player1: { slot: slot1, ...player1 },
                    player2: { slot: slot2, ...player2 },
                    winner: null,
                    completed: false
                };
                
                tournamentState.matches.push(match);
                console.log(`8강 경기: ${player1.name} vs ${player2.name}`);
            }
        }

        // 4강 매칭 선택 모달 표시
        function showMatchSelectionModal(winnerSlot) {
            const modal = document.getElementById('matchSelectionModal');
            const container = document.getElementById('matchSelectionContainer');
            
            remainingByePlayers = selectedByePlayers.filter(slot => 
                !tournamentState.winners[slot] || 
                !tournamentState.matches.some(match => 
                    match.isBye && match.player1.slot === slot
                )
            );
            
            container.innerHTML = remainingByePlayers.map(slot => {
                const player = tournamentAssignments[slot];
                return `
                    <div class="player-selection-card" onclick="selectMatchPlayer('${slot}', '${player.name}')">
                        <div class="player-info">
                            <div class="player-avatar">${slot}</div>
                            <div class="player-details">
                                <h4>${player.name}</h4>
                                <p>슬롯: ${slot}</p>
                            </div>
                        </div>
                        <div class="selection-indicator">
                            <i class="fas fa-check" style="display: none;"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            currentMatchType = 'quarter_final';
            modal.style.display = 'flex';
        }

        // 4강 매칭 선수 선택
        function selectMatchPlayer(slot, name) {
            const cards = document.querySelectorAll('#matchSelectionContainer .player-selection-card');
            cards.forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.selection-indicator i').style.display = 'none';
            });
            
            const selectedCard = event.currentTarget;
            selectedCard.classList.add('selected');
            selectedCard.querySelector('.selection-indicator i').style.display = 'block';
            
            // 확인 버튼 활성화
            document.getElementById('confirmMatchSelection').disabled = false;
        }

        // 4강 매칭 확정
        function confirmMatchSelection() {
            const selectedCard = document.querySelector('#matchSelectionContainer .player-selection-card.selected');
            if (!selectedCard) {
                showToast('선수를 선택해주세요.', 'warning');
                return;
            }
            
            const selectedSlot = selectedCard.querySelector('.player-avatar').textContent;
            const selectedPlayer = tournamentAssignments[selectedSlot];
            
            closeMatchSelectionModal();
            
            if (currentMatchType === 'quarter_final') {
                // 4강 경기 생성
                const winnerSlot = Object.keys(tournamentState.winners)[0];
                const winner = tournamentState.winners[winnerSlot];
                
                const match = {
                    round: 2,
                    player1: winner,
                    player2: { slot: selectedSlot, ...selectedPlayer },
                    winner: null,
                    completed: false
                };
                
                tournamentState.matches.push(match);
                console.log(`4강 경기: ${winner.name} vs ${selectedPlayer.name}`);
                
                // 대진표 업데이트
                updateTournamentDisplay();
                showCurrentMatch();
            }
        }

        // 모달 닫기 함수들
        function closeByeSelectionModal() {
            document.getElementById('byeSelectionModal').style.display = 'none';
        }

        function closeMatchSelectionModal() {
            document.getElementById('matchSelectionModal').style.display = 'none';
        }

        // 토너먼트 선수 등록 모달 관련 함수들
        let selectedTournamentSlot = '';

        function showTournamentPlayerRegisterModal(slot) {
            selectedTournamentSlot = slot;
            const modal = document.getElementById('tournamentPlayerRegisterModal');
            const slotLabel = document.getElementById('selectedSlotLabel');
            const playerList = document.getElementById('tournamentPlayerList');
            
            // 슬롯 라벨 업데이트
            slotLabel.textContent = slot;
            
            // 현재 슬롯에 배정된 선수 확인
            const currentPlayer = tournamentAssignments[slot];
            
            // 등록된 선수 목록 생성
            if (state.players.length === 0) {
                playerList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 16px;">먼저 선수등록 탭에서 선수를 등록해주세요</p>
                    </div>
                `;
            } else {
                playerList.innerHTML = state.players.map(player => {
                    const isAssigned = Object.values(tournamentAssignments).some(assigned => assigned && assigned.name === player.name);
                    const isCurrentSlot = currentPlayer && currentPlayer.name === player.name;
                    
                    return `
                        <div class="player-item" 
                             onclick="${isAssigned && !isCurrentSlot ? '' : 'selectPlayerForTournament(\'' + player.name + '\')'}"
                             style="opacity: ${isAssigned && !isCurrentSlot ? '0.5' : '1'}; cursor: ${isAssigned && !isCurrentSlot ? 'not-allowed' : 'pointer'}; background: ${isCurrentSlot ? '#e8f5e8' : 'white'}; border: ${isCurrentSlot ? '2px solid #4CAF50' : '1px solid var(--border)'};">
                            <div class="player-avatar" style="background: ${player.level === 'A' ? '#ff6b6b' : player.level === 'B' ? '#4ecdc4' : '#45b7d1'};">
                                ${player.name.charAt(0)}
                            </div>
                            <div class="player-info">
                                <div class="player-name">${player.name}</div>
                                <div class="player-level">${player.level}급</div>
                            </div>
                            ${isCurrentSlot ? '<div style="color: #4CAF50; font-weight: bold; font-size: 12px;">현재 배정됨</div>' : ''}
                            ${isAssigned && !isCurrentSlot ? '<div style="color: #f44336; font-weight: bold; font-size: 12px;">이미 배정됨</div>' : ''}
                        </div>
                    `;
                }).join('');
            }
            
            modal.style.display = 'flex';
        }

        function selectPlayerForTournament(playerName) {
            if (!selectedTournamentSlot) return;
            
            // 해당 선수가 이미 다른 슬롯에 배정되어 있는지 확인
            const existingSlot = Object.keys(tournamentAssignments).find(slot => 
                tournamentAssignments[slot] && tournamentAssignments[slot].name === playerName
            );
            
            if (existingSlot && existingSlot !== selectedTournamentSlot) {
                showToast(`${playerName} 선수는 이미 슬롯 ${existingSlot}에 배정되어 있습니다.`, 'warning');
                return;
            }
            
            // 선수 정보 찾기
            const player = state.players.find(p => p.name === playerName);
            if (!player) return;
            
            // 토너먼트 배정에 추가
            tournamentAssignments[selectedTournamentSlot] = {
                name: player.name,
                level: player.level
            };
            
            // 토너먼트 표시 업데이트
            updateTournamentDisplay();
            
            // 모달 닫기
            closeTournamentPlayerRegisterModal();
            
            showToast(`${playerName} 선수가 슬롯 ${selectedTournamentSlot}에 배정되었습니다.`, 'success');
        }

        function clearTournamentSlot() {
            if (!selectedTournamentSlot) return;
            
            if (tournamentAssignments[selectedTournamentSlot]) {
                const playerName = tournamentAssignments[selectedTournamentSlot].name;
                delete tournamentAssignments[selectedTournamentSlot];
                
                // 토너먼트 표시 업데이트
                updateTournamentDisplay();
                
                showToast(`${playerName} 선수가 슬롯 ${selectedTournamentSlot}에서 제거되었습니다.`, 'info');
            }
            
            closeTournamentPlayerRegisterModal();
        }

        function closeTournamentPlayerRegisterModal() {
            document.getElementById('tournamentPlayerRegisterModal').style.display = 'none';
            selectedTournamentSlot = '';
        }

        // 토너먼트 형식 표시
        function showTournamentFormat(format) {
            const formatInfo = document.getElementById('tournamentFormat');
            if (formatInfo) {
                formatInfo.style.display = 'block';
                formatInfo.innerHTML = `
                    <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-trophy" style="color: #1976d2; margin-right: 8px; font-size: 16px;"></i>
                            <div>
                                <div style="font-weight: 600; color: #0d47a1; font-size: 14px;">${format.name}</div>
                                <div style="font-size: 12px; color: #1565c0; margin-top: 2px;">${format.description}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function generateFirstRoundMatches() {
            const assignedPlayers = Object.entries(tournamentAssignments);
            tournamentState.matches = [];
            
            // 토너먼트 형식에 따라 다른 경기 생성
            switch (tournamentState.format.type) {
                case 'round_robin':
                    generateRoundRobinMatches(assignedPlayers);
                    break;
                case 'quarter_final':
                    generateQuarterFinalMatches(assignedPlayers);
                    break;
                case 'group_stage':
                    generateGroupStageMatches(assignedPlayers);
                    break;
                case 'group_stage_32':
                    generateGroupStage32Matches(assignedPlayers);
                    break;
                case 'sixteen_final':
                    generateSixteenFinalMatches(assignedPlayers);
                    break;
                case 'thirty_two_final':
                    generateThirtyTwoFinalMatches(assignedPlayers);
                    break;
                default:
                    generateSixteenFinalMatches(assignedPlayers);
                    break;
            }
        }

        // 라운드 로빈 경기 생성 (2-4명)
        function generateRoundRobinMatches(assignedPlayers) {
            const players = assignedPlayers.map(([slot, player]) => ({ slot, ...player }));
            
            for (let i = 0; i < players.length; i++) {
                for (let j = i + 1; j < players.length; j++) {
                    const match = {
                        round: 1,
                        player1: players[i],
                        player2: players[j],
                        winner: null,
                        completed: false,
                        isRoundRobin: true
                    };
                    tournamentState.matches.push(match);
                    console.log(`라운드 로빈 경기: ${match.player1.slot}(${match.player1.name}) vs ${match.player2.slot}(${match.player2.name})`);
                }
            }
        }

        // 8강 토너먼트 경기 생성 (5-8명)
        function generateQuarterFinalMatches(assignedPlayers) {
            const sortedPlayers = assignedPlayers.sort((a, b) => {
                const labels = 'A B C D E F G H I J K L M N O P'.split(' ');
                return labels.indexOf(a[0]) - labels.indexOf(b[0]);
            });
            
            // 8강으로 맞추기 위해 부전승 처리
            while (sortedPlayers.length < 8) {
                sortedPlayers.push([`BYE${sortedPlayers.length}`, { name: '부전승', slot: `BYE${sortedPlayers.length}` }]);
            }
            
            // 8강 경기 생성
            for (let i = 0; i < 8; i += 2) {
                const player1 = sortedPlayers[i];
                const player2 = sortedPlayers[i + 1];
                
                if (player1[0].startsWith('BYE') || player2[0].startsWith('BYE')) {
                    // 부전승 처리
                    const realPlayer = player1[0].startsWith('BYE') ? player2 : player1;
                    const byeMatch = {
                        round: 1,
                        player1: { slot: realPlayer[0], ...realPlayer[1] },
                        player2: null,
                        winner: { slot: realPlayer[0], ...realPlayer[1] },
                        completed: true,
                        isBye: true
                    };
                    tournamentState.matches.push(byeMatch);
                    tournamentState.winners[realPlayer[0]] = { slot: realPlayer[0], ...realPlayer[1] };
                    console.log(`8강 부전승: ${realPlayer[0]}(${realPlayer[1].name}) - 부전승으로 4강 진출`);
                } else {
                    const match = {
                        round: 1,
                        player1: { slot: player1[0], ...player1[1] },
                        player2: { slot: player2[0], ...player2[1] },
                        winner: null,
                        completed: false
                    };
                    tournamentState.matches.push(match);
                    console.log(`8강 경기: ${match.player1.slot}(${match.player1.name}) vs ${match.player2.slot}(${match.player2.name})`);
                }
            }
        }

        // 조별 예선 경기 생성 (9-12명)
        function generateGroupStageMatches(assignedPlayers) {
            const sortedPlayers = assignedPlayers.sort((a, b) => {
                const labels = 'A B C D E F G H I J K L M N O P'.split(' ');
                return labels.indexOf(a[0]) - labels.indexOf(b[0]);
            });
            
            // 2개 조로 나누기
            const groupA = sortedPlayers.slice(0, Math.ceil(sortedPlayers.length / 2));
            const groupB = sortedPlayers.slice(Math.ceil(sortedPlayers.length / 2));
            
            // A조 경기 생성
            generateGroupMatches(groupA, 'A');
            // B조 경기 생성
            generateGroupMatches(groupB, 'B');
        }

        // 조별 예선 + 32강 경기 생성 (17-32명)
        function generateGroupStage32Matches(assignedPlayers) {
            const sortedPlayers = assignedPlayers.sort((a, b) => {
                const labels = [];
                for (let i = 0; i < 26; i++) {
                    labels.push(String.fromCharCode(65 + i)); // A-Z
                }
                for (let i = 0; i < 6; i++) {
                    labels.push('A' + String.fromCharCode(65 + i)); // AA-AF
                }
                return labels.indexOf(a[0]) - labels.indexOf(b[0]);
            });
            
            // 4개 조로 나누기 (32강을 위한)
            const groupSize = Math.ceil(sortedPlayers.length / 4);
            const groups = ['A', 'B', 'C', 'D'];
            
            for (let i = 0; i < 4; i++) {
                const startIdx = i * groupSize;
                const endIdx = Math.min(startIdx + groupSize, sortedPlayers.length);
                const groupPlayers = sortedPlayers.slice(startIdx, endIdx);
                
                if (groupPlayers.length > 0) {
                    generateGroupMatches(groupPlayers, groups[i]);
                }
            }
        }

        // 조별 경기 생성
        function generateGroupMatches(players, groupName) {
            for (let i = 0; i < players.length; i++) {
                for (let j = i + 1; j < players.length; j++) {
                    const match = {
                        round: 1,
                        player1: { slot: players[i][0], ...players[i][1] },
                        player2: { slot: players[j][0], ...players[j][1] },
                        winner: null,
                        completed: false,
                        group: groupName,
                        isGroupStage: true
                    };
                    tournamentState.matches.push(match);
                    console.log(`${groupName}조 경기: ${match.player1.slot}(${match.player1.name}) vs ${match.player2.slot}(${match.player2.name})`);
                }
            }
        }

        // 16강 토너먼트 경기 생성 (13-16명)
        function generateSixteenFinalMatches(assignedPlayers) {
            const sortedPlayers = assignedPlayers.sort((a, b) => {
                const labels = 'A B C D E F G H I J K L M N O P'.split(' ');
                return labels.indexOf(a[0]) - labels.indexOf(b[0]);
            });
            
            // 16강으로 맞추기 위해 부전승 처리
            while (sortedPlayers.length < 16) {
                sortedPlayers.push([`BYE${sortedPlayers.length}`, { name: '부전승', slot: `BYE${sortedPlayers.length}` }]);
            }
            
            // 16강 경기 생성
            for (let i = 0; i < 16; i += 2) {
                const player1 = sortedPlayers[i];
                const player2 = sortedPlayers[i + 1];
                
                if (player1[0].startsWith('BYE') || player2[0].startsWith('BYE')) {
                    // 부전승 처리
                    const realPlayer = player1[0].startsWith('BYE') ? player2 : player1;
                    const byeMatch = {
                        round: 1,
                        player1: { slot: realPlayer[0], ...realPlayer[1] },
                        player2: null,
                        winner: { slot: realPlayer[0], ...realPlayer[1] },
                        completed: true,
                        isBye: true
                    };
                    tournamentState.matches.push(byeMatch);
                    tournamentState.winners[realPlayer[0]] = { slot: realPlayer[0], ...realPlayer[1] };
                    console.log(`16강 부전승: ${realPlayer[0]}(${realPlayer[1].name}) - 부전승으로 8강 진출`);
                } else {
                    const match = {
                        round: 1,
                        player1: { slot: player1[0], ...player1[1] },
                        player2: { slot: player2[0], ...player2[1] },
                        winner: null,
                        completed: false
                    };
                    tournamentState.matches.push(match);
                    console.log(`16강 경기: ${match.player1.slot}(${match.player1.name}) vs ${match.player2.slot}(${match.player2.name})`);
                }
            }
        }

        // 라운드 완료 처리
        function handleRoundCompletion() {
            switch (tournamentState.format.type) {
                case 'round_robin':
                    handleRoundRobinCompletion();
                    break;
                case 'group_stage':
                case 'group_stage_32':
                    handleGroupStageCompletion();
                    break;
                case 'quarter_final':
                case 'sixteen_final':
                default:
                    handleTournamentCompletion();
                    break;
            }
        }

        // 라운드 로빈 완료 처리
        function handleRoundRobinCompletion() {
            // 라운드 로빈에서는 모든 경기가 완료되면 토너먼트 종료
            completeTournament();
        }

        // 조별 예선 완료 처리
        function handleGroupStageCompletion() {
            if (tournamentState.currentRound === 1) {
                // 조별 예선 완료 - 토너먼트 형식에 따라 다음 단계 진행
                if (tournamentState.format.type === 'group_stage_32') {
                    advanceToGroupStage32Final();
                } else {
                    advanceToGroupStageFinal();
                }
            } else {
                // 토너먼트 완료
                completeTournament();
            }
        }

        // 조별 예선에서 4강 토너먼트로 진행
        function advanceToGroupStageFinal() {
            // 각 조별 순위 계산
            const groupAStandings = calculateGroupStandings('A');
            const groupBStandings = calculateGroupStandings('B');
            
            // 각 조 상위 2명 선발
            const groupAWinners = groupAStandings.slice(0, 2);
            const groupBWinners = groupBStandings.slice(0, 2);
            
            // 4강 토너먼트 경기 생성
            tournamentState.currentRound = 2;
            tournamentState.matches = [];
            
            // A조 1위 vs B조 2위, B조 1위 vs A조 2위
            const semifinal1 = {
                round: 2,
                player1: groupAWinners[0],
                player2: groupBWinners[1],
                winner: null,
                completed: false
            };
            
            const semifinal2 = {
                round: 2,
                player1: groupBWinners[0],
                player2: groupAWinners[1],
                winner: null,
                completed: false
            };
            
            tournamentState.matches.push(semifinal1, semifinal2);
            
            console.log('조별 예선 완료 - 4강 토너먼트 시작');
            console.log(`4강 1경기: ${semifinal1.player1.slot}(${semifinal1.player1.name}) vs ${semifinal1.player2.slot}(${semifinal1.player2.name})`);
            console.log(`4강 2경기: ${semifinal2.player1.slot}(${semifinal2.player1.name}) vs ${semifinal2.player2.slot}(${semifinal2.player2.name})`);
            
            updateTournamentProgress();
            showCurrentMatch();
        }

        // 조별 예선에서 32강 토너먼트로 진행
        function advanceToGroupStage32Final() {
            // 각 조별 순위 계산
            const groupAStandings = calculateGroupStandings('A');
            const groupBStandings = calculateGroupStandings('B');
            const groupCStandings = calculateGroupStandings('C');
            const groupDStandings = calculateGroupStandings('D');
            
            // 각 조 상위 8명씩 선발 (32강을 위해)
            const groupAWinners = groupAStandings.slice(0, 8);
            const groupBWinners = groupBStandings.slice(0, 8);
            const groupCWinners = groupCStandings.slice(0, 8);
            const groupDWinners = groupDStandings.slice(0, 8);
            
            // 32강 토너먼트 배정 (A~AF 슬롯에 순서대로 배정)
            const allWinners = [...groupAWinners, ...groupBWinners, ...groupCWinners, ...groupDWinners];
            const labels = [];
            for (let i = 0; i < 26; i++) {
                labels.push(String.fromCharCode(65 + i)); // A-Z
            }
            for (let i = 0; i < 6; i++) {
                labels.push('A' + String.fromCharCode(65 + i)); // AA-AF
            }
            
            // 32강 토너먼트 배정 업데이트
            allWinners.forEach((player, index) => {
                if (index < 32) {
                    tournamentAssignments[labels[index]] = player;
                }
            });
            
            // 토너먼트 상태 업데이트
            tournamentState.currentRound = 2;
            tournamentState.matches = [];
            tournamentState.winners = {};
            tournamentState.eliminated.clear();
            tournamentState.losers.clear();
            tournamentState.roundWinners = {};
            
            // 32강 경기 생성
            generateThirtyTwoFinalMatches(Object.entries(tournamentAssignments));
            
            console.log('조별 예선 완료 - 32강 토너먼트 시작');
            console.log(`A조 진출자: ${groupAWinners.map(p => p.name).join(', ')}`);
            console.log(`B조 진출자: ${groupBWinners.map(p => p.name).join(', ')}`);
            console.log(`C조 진출자: ${groupCWinners.map(p => p.name).join(', ')}`);
            console.log(`D조 진출자: ${groupDWinners.map(p => p.name).join(', ')}`);
            
            updateTournamentProgress();
            updateTournamentDisplay();
            drawTournamentBracket();
            showCurrentMatch();
        }

        // 조별 순위 계산
        function calculateGroupStandings(groupName) {
            const groupMatches = tournamentState.matches.filter(match => match.group === groupName);
            const players = {};
            
            // 각 선수의 승수, 패수, 득실차 계산
            groupMatches.forEach(match => {
                if (match.completed && match.winner) {
                    const winner = match.winner.slot;
                    const loser = match.player1.slot === winner ? match.player2.slot : match.player1.slot;
                    
                    if (!players[winner]) players[winner] = { slot: winner, wins: 0, losses: 0, name: match.winner.name };
                    if (!players[loser]) players[loser] = { slot: loser, wins: 0, losses: 0, name: match.player1.slot === winner ? match.player2.name : match.player1.name };
                    
                    players[winner].wins++;
                    players[loser].losses++;
                }
            });
            
            // 순위 정렬 (승수 기준, 승수가 같으면 슬롯 순서)
            return Object.values(players).sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                return a.slot.localeCompare(b.slot);
            });
        }

        // 일반 토너먼트 완료 처리
        function handleTournamentCompletion() {
            if (tournamentState.currentRound === 1) {
                // 2라운드로 진행
                advanceToNextRound();
            } else if (tournamentState.currentRound === 2) {
                // 2라운드 완료 - 부전승 선수가 있으면 결승전 설정
                setupFinalMatch();
            } else {
                // 토너먼트 완료
                completeTournament();
            }
        }


        function showCurrentMatch() {
            // 실제 선수가 있는 경기만 찾기 (부전승 경기도 제외)
            const currentMatch = tournamentState.matches.find(match => 
                !match.completed && 
                !match.isBye &&
                match.player1 && 
                match.player2 &&
                match.player1.name && 
                match.player2.name
            );
            
            if (!currentMatch) {
                // 모든 실제 경기 완료 - 토너먼트 형식에 따라 처리
                handleRoundCompletion();
                return;
            }

            tournamentState.currentMatch = currentMatch;
            const currentMatchDiv = document.getElementById('currentMatch');
            const currentMatchPlayers = document.getElementById('currentMatchPlayers');
            
            currentMatchDiv.style.display = 'block';
            currentMatchPlayers.innerHTML = `
                <div class="match-player" data-player-slot="${currentMatch.player1.slot}">
                    <div style="font-weight: 600; margin-bottom: 4px;">${currentMatch.player1.slot}</div>
                    <div>${currentMatch.player1.name}</div>
                </div>
                <div class="vs-text">VS</div>
                <div class="match-player" data-player-slot="${currentMatch.player2.slot}">
                    <div style="font-weight: 600; margin-bottom: 4px;">${currentMatch.player2.slot}</div>
                    <div>${currentMatch.player2.name}</div>
                </div>
            `;

            // 선수 클릭 이벤트 추가
            currentMatchPlayers.querySelectorAll('.match-player').forEach(player => {
                player.addEventListener('click', selectMatchWinner);
            });

            document.getElementById('selectWinner').style.display = 'none';
        }

        function selectMatchWinner(event) {
            // 기존 선택 해제
            document.querySelectorAll('.match-player').forEach(p => p.classList.remove('selected'));
            
            // 새 선택
            const selectedPlayer = event.currentTarget;
            selectedPlayer.classList.add('selected');
            
            // 우승자 선택 버튼 표시
            document.getElementById('selectWinner').style.display = 'inline-block';
            document.getElementById('selectWinner').onclick = () => confirmWinner(selectedPlayer.dataset.playerSlot);
        }

        function confirmWinner(winnerSlot) {
            const currentMatch = tournamentState.currentMatch;
            const winner = winnerSlot === currentMatch.player1.slot ? currentMatch.player1 : currentMatch.player2;
            const loser = winnerSlot === currentMatch.player1.slot ? currentMatch.player2 : currentMatch.player1;

            // 경기 결과 저장
            currentMatch.winner = winner;
            currentMatch.completed = true;
            tournamentState.winners[winnerSlot] = winner;
            tournamentState.eliminated.add(loser.slot);

            // E vs F 매치에서 E가 우승한 경우 특별 처리
            if (currentMatch.round === 1 && 
                ((currentMatch.player1.slot === 'E' && currentMatch.player2.slot === 'F') || 
                 (currentMatch.player1.slot === 'F' && currentMatch.player2.slot === 'E')) &&
                winnerSlot === 'E') {
                
                // E가 부전승으로 결승에 진출하는 경기 생성
                const byeMatch = {
                    round: 2,
                    player1: winner,
                    player2: null, // 부전승
                    winner: winner, // 자동으로 E가 승자
                    completed: true, // 부전승은 즉시 완료
                    isBye: true, // 부전승 표시
                    isAutoAdvance: true // 자동 진출 표시
                };
                tournamentState.matches.push(byeMatch);
                tournamentState.winners[winnerSlot] = winner;
                console.log(`E vs F에서 E 승리: ${winner.slot}(${winner.name}) - 부전승으로 결승 진출`);
                
                // 부전승 효과 표시
                setTimeout(() => {
                    showByeEffect(winnerSlot);
                }, 1000);
            }

            // 시각적 효과
            showWinnerEffect(winnerSlot, loser.slot);
            
            // 다음 경기로
            setTimeout(() => {
                showCurrentMatch();
                updateTournamentProgress();
            }, 2000);
        }

        function showWinnerEffect(winnerSlot, loserSlot) {
            const winnerElement = document.querySelector(`[data-label="${winnerSlot}"]`);
            const loserElement = document.querySelector(`[data-label="${loserSlot}"]`);

            if (winnerElement) {
                winnerElement.classList.add('winner');
            }

            if (loserElement) {
                loserElement.classList.add('eliminated');
            }

            showToast(`${tournamentAssignments[winnerSlot].name}이(가) 승리했습니다!`, 'success');
        }

        function showEmptySlotEffect(emptySlot) {
            const emptyElement = document.querySelector(`[data-label="${emptySlot}"]`);
            
            if (emptyElement) {
                emptyElement.classList.add('empty-slot');
            }
        }

        function showByeEffect(byeSlot) {
            const byeElement = document.querySelector(`[data-label="${byeSlot}"]`);
            
            if (byeElement) {
                byeElement.classList.add('bye');
            }

            showToast(`${tournamentAssignments[byeSlot].name}이(가) 부전승으로 결승에 진출했습니다!`, 'info');
        }

        function setupFinalMatch() {
            // 2라운드 완료 후 결승전 설정
            const byePlayer = tournamentState.matches.find(match => 
                match.round === 2 && match.isBye && match.isAutoAdvance
            );
            
            if (byePlayer) {
                // 부전승 선수가 있으면 첫 번째 2라운드 경기의 승자와 결승전 경기 생성
                const firstRound2Match = tournamentState.matches.find(match => 
                    match.round === 2 && 
                    match.completed && 
                    !match.isBye && 
                    !match.isEmptySlot &&
                    match.winner
                );
                
                if (firstRound2Match && firstRound2Match.winner) {
                    const finalMatch = {
                        round: 3, // 결승전을 3라운드로 설정
                        player1: byePlayer.winner, // 부전승 선수
                        player2: firstRound2Match.winner, // 2라운드 승자
                        winner: null,
                        completed: false,
                        isFinal: true // 결승전 표시
                    };
                    tournamentState.matches.push(finalMatch);
                    tournamentState.currentRound = 3; // 결승전 라운드
                    updateTournamentRound();
                    showCurrentMatch();
                    console.log(`결승전 설정: ${finalMatch.player1.slot}(${finalMatch.player1.name}) vs ${finalMatch.player2.slot}(${finalMatch.player2.name})`);
                } else {
                    // 2라운드 경기가 아직 완료되지 않은 경우 토너먼트 완료
                    completeTournament();
                }
            } else {
                // 부전승 선수가 없는 경우 토너먼트 완료
                completeTournament();
            }
        }

        function advanceToNextRound() {
            // 이전 라운드의 승자들을 현재 라운드 승자로 저장
            const previousRound = tournamentState.currentRound;
            tournamentState.roundWinners[previousRound] = Object.values(tournamentState.winners);
            
            tournamentState.currentRound++;
            
            // 이전 라운드의 승자들 가져오기
            const currentWinners = tournamentState.roundWinners[previousRound] || [];
            
            // 이전 라운드 경기만 유지
            tournamentState.matches = tournamentState.matches.filter(match => match.round < tournamentState.currentRound);
            
            // 대진표 방식으로 경기 생성
            const roundMatches = bracketMatches[tournamentState.currentRound];
            if (roundMatches) {
                for (const matchPair of roundMatches) {
                    const [slot1, slot2] = matchPair;
                    const player1 = tournamentAssignments[slot1];
                    const player2 = tournamentAssignments[slot2];
                    
                    // 두 선수 모두 등록되어 있고 이전 라운드에서 승리했는지 확인
                    if (player1 && player2) {
                        const isWinner1 = currentWinners.some(winner => winner.slot === slot1);
                        const isWinner2 = currentWinners.some(winner => winner.slot === slot2);
                        
                        if (isWinner1 && isWinner2) {
                            // 두 선수 모두 승자라면 경기 생성
                    const match = {
                                round: tournamentState.currentRound,
                                player1: { slot: slot1, ...player1 },
                                player2: { slot: slot2, ...player2 },
                        winner: null,
                        completed: false
                    };
                    tournamentState.matches.push(match);
                            const roundName = tournamentState.currentRound === 1 ? '16강' : 
                                            tournamentState.currentRound === 2 ? '8강' : 
                                            tournamentState.currentRound === 3 ? '4강' : '결승';
                            console.log(`${roundName} 경기 생성: ${match.player1.slot}(${match.player1.name}) vs ${match.player2.slot}(${match.player2.name})`);
                        } else if (isWinner1 || isWinner2) {
                            // 한 명만 승자라면 부전승 처리
                            const winner = isWinner1 ? { slot: slot1, ...player1 } : { slot: slot2, ...player2 };
                            const byeMatch = {
                                round: tournamentState.currentRound,
                                player1: winner,
                                player2: null, // 부전승
                                winner: winner, // 자동 승리
                                completed: true, // 자동 완료
                                isBye: true // 부전승 표시
                            };
                            tournamentState.matches.push(byeMatch);
                            tournamentState.winners[winner.slot] = winner;
                            
                            // 부전승 승자를 현재 라운드 승자로 추가
                            if (!tournamentState.roundWinners[tournamentState.currentRound]) {
                                tournamentState.roundWinners[tournamentState.currentRound] = [];
                            }
                            tournamentState.roundWinners[tournamentState.currentRound].push(winner);
                            
                            const roundName = tournamentState.currentRound === 1 ? '16강' : 
                                            tournamentState.currentRound === 2 ? '8강' : 
                                            tournamentState.currentRound === 3 ? '4강' : '결승';
                            const nextRoundName = tournamentState.currentRound === 1 ? '8강' : 
                                                tournamentState.currentRound === 2 ? '4강' : 
                                                tournamentState.currentRound === 3 ? '결승' : '우승';
                            console.log(`${roundName} 부전승: ${winner.slot}(${winner.name}) - 부전승으로 ${nextRoundName} 진출`);
                        }
                    }
                }
            }
            
            // 다음 라운드가 필요한지 확인
            const nextRoundWinners = tournamentState.roundWinners[tournamentState.currentRound] || [];
            if (nextRoundWinners.length <= 1) {
                // 토너먼트 완료
                completeTournament();
            }
            
            updateTournamentRound();
            showCurrentMatch();
        }

        // 대진표 방식으로 매치되는 선수 찾기
        function findBracketMatch(slot, round) {
            const roundMatches = bracketMatches[round];
            if (!roundMatches) return null;

            for (const match of roundMatches) {
                if (match.includes(slot)) {
                    // 해당 슬롯이 포함된 매치에서 상대방 찾기
                    const opponent = match.find(s => s !== slot);
                    return {
                        player1: slot,
                        player2: opponent,
                        match: match
                    };
                }
            }
            return null;
        }

        // 실제 선수 정보로 매치 생성
        function createBracketMatch(slot, round) {
            const bracketMatch = findBracketMatch(slot, round);
            if (!bracketMatch) return null;

            // 부전승 선수인지 먼저 확인
            const isByePlayer = tournamentState.winners[slot] && 
                tournamentState.matches.some(match => 
                    match.isBye && match.player1.slot === slot
                );
            
            if (isByePlayer) {
                // 부전승 선수는 이미 다음 라운드에 진출했으므로 매치 생성하지 않음
                return null;
            }

            // 현재 클릭한 선수가 이전 라운드에서 승리했는지 확인
            const prevRoundWinners = tournamentState.roundWinners[round - 1] || [];
            const isPlayer1Winner = prevRoundWinners.some(winner => winner.slot === bracketMatch.player1);
            
            if (!isPlayer1Winner) {
                // 현재 선수가 이전 라운드에서 승리하지 않았음
                return null;
            }

            // 상대방 선수가 이전 라운드에서 승리했는지 확인
            const isPlayer2Winner = prevRoundWinners.some(winner => winner.slot === bracketMatch.player2);
            
            if (!isPlayer2Winner) {
                // 상대방이 이전 라운드에서 승리하지 않았음
                return null;
            }

            // 두 선수 모두 이전 라운드에서 승리했다면 매치 생성
            const player1 = prevRoundWinners.find(winner => winner.slot === bracketMatch.player1);
            const player2 = prevRoundWinners.find(winner => winner.slot === bracketMatch.player2);

            return {
                round: round,
                player1: { slot: bracketMatch.player1, ...player1 },
                player2: { slot: bracketMatch.player2, ...player2 },
                winner: null,
                completed: false
            };
        }

        // 선수 클릭 시 경기 정보 표시
        function showPlayerMatchInfo(slot) {
            // 토너먼트가 시작되지 않았으면 경고
            if (!tournamentState.isStarted) {
                showToast('토너먼트를 먼저 시작해주세요.', 'warning');
                return;
            }

            // 해당 슬롯에 선수가 배정되어 있는지 확인
            if (!tournamentAssignments[slot]) {
                showToast('해당 슬롯에 선수가 배정되지 않았습니다.', 'warning');
                return;
            }

            // 부전승 선수인지 먼저 확인
            const isByePlayer = tournamentState.winners[slot] && 
                tournamentState.matches.some(match => 
                    match.isBye && match.player1.slot === slot
                );
            
            if (isByePlayer) {
                // 부전승 선수의 현재 상태 확인
                const byeMatch = tournamentState.matches.find(match => 
                    match.isBye && match.player1.slot === slot
                );
                
                if (byeMatch) {
                    const currentRound = tournamentState.currentRound;
                    const byeRound = byeMatch.round;
                    
                    if (byeRound < currentRound) {
                        // 이미 다음 라운드로 진출한 경우
                        const nextRoundName = byeRound === 1 ? '8강' : 
                                            byeRound === 2 ? '4강' : '결승';
                        showToast(`해당 선수는 부전승으로 ${nextRoundName}에 진출했습니다.`, 'info');
                    } else if (byeRound === currentRound) {
                        // 현재 라운드에서 대기 중인 경우
                        const roundName = currentRound === 1 ? '16강' : 
                                        currentRound === 2 ? '8강' : 
                                        currentRound === 3 ? '4강' : '결승';
                        showToast(`해당 선수는 부전승으로 ${roundName} 대기중입니다.`, 'info');
                    } else {
                        // 아직 해당 라운드가 시작되지 않은 경우
                        showToast('해당 선수는 부전승으로 대기중입니다.', 'info');
                    }
                } else {
                    showToast('해당 선수는 부전승으로 대기중입니다.', 'info');
                }
                return;
            }

            // 대진표 방식으로 현재 라운드의 매치 찾기
            let match = null;
            
            // 먼저 기존 경기에서 찾기
            const existingMatch = tournamentState.matches.find(m => 
                m.round === tournamentState.currentRound && 
                !m.completed && 
                !m.isBye &&
                m.player1 && 
                m.player2 &&
                (m.player1.slot === slot || m.player2.slot === slot)
            );
            
            if (existingMatch) {
                match = existingMatch;
            } else {
                // 기존 경기가 없으면 대진표 방식으로 새 매치 생성
                const bracketMatch = createBracketMatch(slot, tournamentState.currentRound);
                if (bracketMatch) {
                    // 매치 생성 성공
                    match = bracketMatch;
                    tournamentState.matches.push(match);
                } else {
                    // 매치를 찾을 수 없음 - 이전 라운드 승자 여부 확인
                    const prevRoundWinners = tournamentState.roundWinners[tournamentState.currentRound - 1] || [];
                    const isWinner = prevRoundWinners.some(winner => winner.slot === slot);
                    
                    if (isWinner) {
                        // 현재 라운드에서 상대방이 아직 이전 라운드에서 승리하지 않았을 수 있음
                        const roundName = tournamentState.currentRound === 1 ? '16강' : 
                                        tournamentState.currentRound === 2 ? '8강' : 
                                        tournamentState.currentRound === 3 ? '4강' : '결승';
                        const prevRoundName = tournamentState.currentRound === 1 ? '예선' : 
                                           tournamentState.currentRound === 2 ? '16강' : 
                                           tournamentState.currentRound === 3 ? '8강' : '4강';
                        
                        showToast(`${roundName} 경기 상대방이 아직 ${prevRoundName}에서 승리하지 않았습니다. ${prevRoundName} 경기를 먼저 완료해주세요.`, 'info');
                    } else {
                        // 해당 선수가 이전 라운드에서 패배했거나 현재 라운드에 참여할 자격이 없음
                        const roundName = tournamentState.currentRound === 1 ? '16강' : 
                                        tournamentState.currentRound === 2 ? '8강' : 
                                        tournamentState.currentRound === 3 ? '4강' : '결승';
                        const prevRoundName = tournamentState.currentRound === 1 ? '예선' : 
                                           tournamentState.currentRound === 2 ? '16강' : 
                                           tournamentState.currentRound === 3 ? '8강' : '4강';
                        
                        showToast(`해당 선수는 ${prevRoundName}에서 탈락했습니다. ${roundName} 경기에 참여할 수 없습니다.`, 'warning');
                    }
                    return;
                }
            }
            currentMatchInfo = match;
            selectedWinner = null;

            // 모달에 경기 정보 표시
            const roundName = tournamentState.currentRound === 1 ? '16강' : 
                            tournamentState.currentRound === 2 ? '8강' : 
                            tournamentState.currentRound === 3 ? '4강' : '결승';
            
            document.getElementById('matchRoundInfo').textContent = `${roundName} 경기`;
            document.getElementById('player1Name').textContent = match.player1.name;
            document.getElementById('player1Slot').textContent = `(${match.player1.slot})`;
            document.getElementById('player2Name').textContent = match.player2.name;
            document.getElementById('player2Slot').textContent = `(${match.player2.slot})`;

            // 선택 상태 초기화
            document.getElementById('matchPlayer1').classList.remove('selected');
            document.getElementById('matchPlayer2').classList.remove('selected');
            document.getElementById('confirmWinnerBtn').disabled = true;

            // 모달 표시
            document.getElementById('matchInfoModal').style.display = 'flex';
        }

        // 승자 선택
        function selectMatchWinner(playerNumber) {
            if (!currentMatchInfo) return;

            // 선택 상태 업데이트
            document.getElementById('matchPlayer1').classList.remove('selected');
            document.getElementById('matchPlayer2').classList.remove('selected');
            document.getElementById(`matchPlayer${playerNumber}`).classList.add('selected');

            selectedWinner = playerNumber;
            document.getElementById('confirmWinnerBtn').disabled = false;
        }

        // 승자 확정
        function confirmMatchWinner() {
            if (!currentMatchInfo || !selectedWinner) return;

            const winner = selectedWinner === 1 ? currentMatchInfo.player1 : currentMatchInfo.player2;
            const loser = selectedWinner === 1 ? currentMatchInfo.player2 : currentMatchInfo.player1;

            // 경기 결과 업데이트
            currentMatchInfo.winner = winner;
            currentMatchInfo.completed = true;
            tournamentState.winners[winner.slot] = winner;
            
            // 라운드별 승자 추적
            if (!tournamentState.roundWinners[tournamentState.currentRound]) {
                tournamentState.roundWinners[tournamentState.currentRound] = [];
            }
            tournamentState.roundWinners[tournamentState.currentRound].push(winner);
            
            // 패자 추적
            tournamentState.losers.add(loser.slot);

            // UI 업데이트
            updateTournamentDisplay();
            updateTournamentRound();
            showCurrentMatch();

            // 모달 닫기
            closeMatchInfoModal();

            showToast(`${winner.name}(${winner.slot}) 승리!`, 'success');

            // 다음 라운드로 진행할지 확인
            const currentRoundMatches = tournamentState.matches.filter(match => 
                match.round === tournamentState.currentRound && !match.completed
            );

            if (currentRoundMatches.length === 0) {
                // 현재 라운드의 모든 경기가 완료되면 다음 라운드로 진행
                setTimeout(() => {
                    advanceToNextRound();
                }, 1000);
            }
        }

        // 경기 정보 모달 닫기
        function closeMatchInfoModal() {
            document.getElementById('matchInfoModal').style.display = 'none';
            currentMatchInfo = null;
            selectedWinner = null;
        }

        // 모달 외부 클릭 시 닫기
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('matchInfoModal');
            if (event.target === modal) {
                closeMatchInfoModal();
            }
        });

        function completeTournament() {
            const finalWinner = Object.values(tournamentState.winners)[0];
            showToast(`🏆 토너먼트 완료! 우승자: ${finalWinner.name}`, 'success');
            
            // 최종 우승자 강조
            const winnerElement = document.querySelector(`[data-label="${finalWinner.slot}"]`);
            if (winnerElement) {
                winnerElement.classList.add('winner');
            }
        }

        function selectTournamentWinner(selectedSlot) {
            // 토너먼트가 시작되지 않았으면 경고
            if (!tournamentState.isStarted) {
                showToast('토너먼트를 먼저 시작해주세요.', 'warning');
                return;
            }

            // 선택된 슬롯에 선수가 배정되어 있는지 확인
            if (!tournamentAssignments[selectedSlot]) {
                showToast('해당 슬롯에 선수가 배정되지 않았습니다.', 'warning');
                return;
            }

            // 현재 라운드의 경기 중에서 선택된 선수가 포함된 경기 찾기 (실제 선수가 있는 경기만)
            const currentRoundMatches = tournamentState.matches.filter(match => 
                match.round === tournamentState.currentRound && 
                !match.completed && 
                !match.isBye &&
                match.player1 && 
                match.player2 &&
                match.player1.name && 
                match.player2.name
            );
            
            const currentMatch = currentRoundMatches.find(match => 
                match.player1.slot === selectedSlot || match.player2.slot === selectedSlot
            );

            if (!currentMatch) {
                showToast('현재 라운드에서 해당 선수의 경기가 없습니다.', 'warning');
                return;
            }

            // 승자 선택
            const winner = currentMatch.player1.slot === selectedSlot ? currentMatch.player1 : currentMatch.player2;
            const loser = currentMatch.player1.slot === selectedSlot ? currentMatch.player2 : currentMatch.player1;

            // 경기 완료 처리
            currentMatch.completed = true;
            currentMatch.winner = winner;
            tournamentState.winners[winner.slot] = winner;
            tournamentState.eliminated.add(loser.slot);

            // 승자 시각적 표시
            const winnerElement = document.querySelector(`[data-label="${winner.slot}"]`);
            const loserElement = document.querySelector(`[data-label="${loser.slot}"]`);
            
            if (winnerElement) {
                winnerElement.style.background = '#4CAF50';
                winnerElement.style.color = 'white';
                winnerElement.style.border = '2px solid #2E7D32';
            }
            
            if (loserElement) {
                loserElement.style.background = '#f44336';
                loserElement.style.color = 'white';
                loserElement.style.border = '2px solid #c62828';
            }

            showToast(`${winner.name} 승리!`, 'success');

            // 다음 라운드로 진행할지 확인
            const remainingMatches = tournamentState.matches.filter(match => 
                match.round === tournamentState.currentRound && !match.completed
            );

            if (remainingMatches.length === 0) {
                // 현재 라운드 완료 - 다음 라운드로 진행
                if (tournamentState.format.type === 'five_player_tournament' && tournamentState.currentRound === 1) {
                    // 5명 토너먼트 8강 완료 후 4강 매칭 선택
                    const winnerSlot = Object.keys(tournamentState.winners)[0];
                    setTimeout(() => {
                        showMatchSelectionModal(winnerSlot);
                    }, 1000);
                } else {
                    setTimeout(() => {
                        advanceToNextRound();
                    }, 1000);
                }
            }

            updateTournamentProgress();
        }

        function updateTournamentProgress() {
            // 빈 슬롯이 아닌 실제 경기만 카운트 (부전승 경기도 포함)
            const actualMatches = tournamentState.matches.filter(m => !m.isEmptySlot && m.player1 && m.player2);
            const totalMatches = actualMatches.length;
            const completedMatches = actualMatches.filter(m => m.completed).length;
            const progress = totalMatches > 0 ? (completedMatches / totalMatches) * 100 : 0;
            
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function updateTournamentRound() {
            let roundText = '';
            if (tournamentState.currentRound === 1) {
                roundText = '16강';
            } else if (tournamentState.currentRound === 2) {
                roundText = '8강';
            } else if (tournamentState.currentRound === 3) {
                roundText = '4강';
            } else if (tournamentState.currentRound === 4) {
                roundText = '결승';
            } else {
                roundText = `${tournamentState.currentRound}라운드`;
            }
            document.getElementById('tournamentRound').textContent = roundText;
        }

        function resetTournament() {
            tournamentState = {
                isStarted: false,
                currentRound: 1,
                currentMatch: null,
                matches: [],
                winners: {},
                eliminated: new Set(),
                losers: new Set(),
                roundWinners: {}
            };

            // UI 초기화
            document.getElementById('startTournament').style.display = 'inline-block';
            document.getElementById('resetTournament').style.display = 'none';
            document.getElementById('currentMatch').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('tournamentRound').textContent = '1라운드';

            // 선수 박스 초기화
            document.querySelectorAll('.tournament-player').forEach(player => {
                player.classList.remove('winner', 'eliminated', 'empty-slot', 'bye');
            });

            showToast('토너먼트가 초기화되었습니다.', 'info');
        }

        // 앱 시작
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>